<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pháo Hoa Cao Trào Lặp Lại</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            font-family: system-ui, sans-serif;
            color: #fff;
        }
        #canvas {
            position: absolute;
            inset: 0;
            z-index: 1;
            display: none;
        }
        #startBtn {
            position: relative;
            z-index: 10;
            padding: 20px 54px;
            font-size: 30px;
            font-weight: 700;
            color: #111;
            background: linear-gradient(135deg, #ffffff, #f3f3f3);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 28px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: transform 0.35s cubic-bezier(.22,1,.36,1), box-shadow 0.35s ease, background 0.35s ease;
            letter-spacing: 0.5px;
            animation: floatSoft 4s ease-in-out infinite;
            overflow: hidden;
        }

        #startBtn::after {
            content: "";
            position: absolute;
            top: 0;
            left: -120%;
            width: 120%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255,255,255,0.7), transparent);
            transition: left 0.6s ease;
        }

        #startBtn:hover::after {
            left: 120%;
        }

        #startBtn:hover {
            transform: translateY(-6px);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 1);
        }

        #startBtn:active {
            transform: scale(0.92);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            transition: transform 0.15s ease;
        }

        #startBtn.clicked {
            animation: fadeOutSmooth 0.9s cubic-bezier(.4,0,.2,1) forwards;
        }

        .btn-text {
            position: relative;
            z-index: 1;
            color: #111;
        }

        @keyframes floatSoft {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        @keyframes fadeOutSmooth {
            0% { opacity: 1; transform: scale(1) translateY(0); }
            40% { opacity: 0.8; transform: scale(1.05) translateY(-16px); }
            100% { opacity: 0; transform: scale(0.7) translateY(60px); visibility: hidden; }
        }
    </style>
</head>
<body>
    <button id="startBtn">
        <span class="btn-text">BẮT ĐẦU</span>
    </button>
    <canvas id="canvas"></canvas>

    <script>
        // ====================== CẤU HÌNH ÂM THANH ======================
        const SOUND_CONFIG = {
            masterVolume: 1.2,
            baseInterval: 1400, // NHANH HƠN
            intervalVariation: 800,
            fadeInTime: 0.2,
            fadeOutTime: 1.2,
            frequencyBlend: {
                min: 30,
                max: 80,
                glideTime: 0.6
            },
            layers: {
                sub: { weight: 0.9, freqRange: [30, 70] },
                deep: { weight: 0.6, freqRange: [20, 45] },
                rumble: { weight: 0.3, freqRange: [100, 300] }
            }
        };

        // ====================== CẤU HÌNH PHÁO HOA - TĂNG SỐ LƯỢNG & HIỆU ỨNG ======================
        const FIREWORK_CONFIG = {
            maxParticlesPerExplosion: 150, // TĂNG: từ 100 lên 150
            maxIntensity: 3.0, // TĂNG: từ 2.5 lên 3.0
            
            // Hệ thống điều chỉnh tốc độ - TĂNG TẦN SUẤT
            adaptiveExplosionRate: {
                // Tốc độ bình thường - NHANH HƠN
                normalRate: {
                    minInterval: 1500, // GIẢM: từ 2000 xuống 1500
                    maxInterval: 2500   // GIẢM: từ 3000 xuống 2500
                },
                
                // Tốc độ cao trào - DÀY ĐẶC HƠN
                climaxRate: {
                    minInterval: 150,     // GIẢM: từ 200 xuống 150
                    maxInterval: 350,     // GIẢM: từ 400 xuống 350
                    duration: 8000,
                    burstCount: 3,        // TĂNG: từ 2 lên 3 rocket
                    burstDelay: 80        // GIẢM: từ 100 xuống 80
                },
                
                // Các giai đoạn
                phases: {
                    buildup: 7000,
                    climax: 8000,
                    cooldown: 7000
                },
                loopDelay: 15000
            },
            
            targetFPS: 60,
            maxActiveParticles: 1800,     // TĂNG: từ 1500 lên 1800
            particleSizeMultiplier: 0.45, // TĂNG NHẸ: từ 0.4 lên 0.45
            rocketSpeedMultiplier: 0.85,  // TĂNG: từ 0.8 lên 0.85
            explosionSpeedMultiplier: 0.75, // TĂNG: từ 0.7 lên 0.75
            
            // CẤU HÌNH KHOẢNG CÁCH: ĐA DẠNG XA GẦN XEN KẼ
            distanceDistribution: {
                near: 0.4,      // TĂNG: từ 0.2 lên 0.4 (nhiều pháo gần hơn)
                medium: 0.3,    // THÊM: pháo tầm trung
                far: 0.3        // GIẢM: từ 0.8 xuống 0.3
            },
            
            distanceSettings: {
                near: {
                    minHeight: 0.15,      // GIẢM: gần màn hình hơn
                    maxHeight: 0.35,      // GIẢM
                    sizeMultiplier: 1.2,  // TĂNG: từ 1.0 lên 1.2
                    speedMultiplier: 1.15, // TĂNG: từ 1.0 lên 1.15
                    brightnessBoost: 1.25, // TĂNG: từ 1.0 lên 1.25
                    glowIntensity: 1.3,   // TĂNG: từ 1.0 lên 1.3
                    particleMultiplier: 1.4, // THÊM: nhiều hạt hơn
                    sparkleChance: 0.7    // THÊM: nhiều hiệu ứng lấp lánh
                },
                medium: { // THÊM: tầm trung
                    minHeight: 0.4,
                    maxHeight: 0.6,
                    sizeMultiplier: 1.0,
                    speedMultiplier: 1.0,
                    brightnessBoost: 1.1,
                    glowIntensity: 1.0,
                    particleMultiplier: 1.0,
                    sparkleChance: 0.5
                },
                far: {
                    minHeight: 0.65,      // TĂNG
                    maxHeight: 0.95,      // TĂNG
                    sizeMultiplier: 0.7,  // TĂNG: từ 0.6 lên 0.7
                    speedMultiplier: 0.85, // TĂNG: từ 0.8 lên 0.85
                    brightnessBoost: 0.9, // TĂNG: từ 0.8 lên 0.9
                    glowIntensity: 0.8,   // TĂNG: từ 0.7 lên 0.8
                    particleMultiplier: 0.8, // THÊM
                    sparkleChance: 0.3
                }
            },
            
            // SAO BĂNG CONFIG
            shootingStars: {
                count: 5,
                speed: 14,
                length: 80,
                colors: [
                    '#ffffff', '#a7d8ff', '#ffb3ba', '#ffdfba', 
                    '#ffffba', '#baffc9', '#bae1ff', '#f8b3ff'
                ],
                baseSize: 1.5,
                fadeDuration: 1200,
                
                mobile: {
                    speed: 12,
                    length: 60,
                    baseSize: 1.2
                }
            },
            
            // CÁC LOẠI PHÁO HOA - THÊM NHIỀU LOẠI SINH ĐỘNG
            explosionTypes: {
                normal: {
                    chrysanthemum: 0.25,
                    peony: 0.25,
                    palm: 0.12,
                    willow: 0.10,
                    ring: 0.10,
                    crossette: 0.08,
                    double_ring: 0.05, // THÊM: vòng kép
                    spiral: 0.03,      // THÊM: xoắn ốc
                    heart: 0.02        // THÊM: hình tim
                },
                climax: {
                    chrysanthemum: 0.20,
                    peony: 0.20,
                    palm: 0.10,
                    willow: 0.10,
                    ring: 0.10,
                    crossette: 0.10,
                    double_ring: 0.08, // THÊM
                    spiral: 0.06,      // THÊM
                    heart: 0.04,       // THÊM
                    special: 0.02
                }
            },
            
            // HIỆU ỨNG ĐẶC BIỆT - THÊM
            specialEffects: {
                sparkleChance: 0.4,     // TĂNG cơ hội lấp lánh
                glitterChance: 0.3,     // THÊM hiệu ứng kim tuyến
                trailChance: 0.6,       // TĂNG cơ hội có đuôi
                colorShiftChance: 0.4,  // THÊM chuyển màu
                pulseChance: 0.25,      // THÊM nhấp nháy
                secondaryExplosionChance: 0.2 // THÊM nổ thứ cấp
            }
        };

        const MUSIC_FILE = 'phaobong.mp3';

        let canvas, ctx, audioCtx, masterGain, backgroundMusic;
        let particles = [];
        let shootingStars = [];
        let particlePoolSize = FIREWORK_CONFIG.maxParticlesPerExplosion * 30; // TĂNG: từ 25 lên 30
        let lastTime = 0, startTime = 0;
        let isRunning = false;
        let showShootingStars = true;
        let finalShootingStarsActive = false;
        let nextExplosionTime = 0;
        let nextSoundTime = 0;
        let soundSequence = 0;
        let activeSounds = new Set();
        let isMusicLoaded = false;
        let isMusicPlaying = false;
        let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // Hệ thống điều chỉnh cao trào
        let climaxSystem = {
            phase: 'buildup',
            phaseStartTime: 0,
            climaxIntensity: 1.0,
            isClimaxActive: false,
            climaxMultiplier: 1.0,
            loopCounter: 0,
            maxLoops: 100,
            lastLoopTime: 0,
            
            soundIntensity: 1.0,
            lastBassTime: 0,
            bassInterval: 700, // GIẢM: từ 800 xuống 700
            currentDistanceType: 'near' // THÊM: theo dõi loại khoảng cách hiện tại
        };

        // ====================== HỆ THỐNG SAO BĂNG ======================
        function createShootingStars(count = FIREWORK_CONFIG.shootingStars.count) {
            const starsConfig = FIREWORK_CONFIG.shootingStars;
            const mobileConfig = isMobile ? starsConfig.mobile : {};
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    if (!isRunning) return;
                    
                    const sizeCategory = Math.random();
                    let sizeMultiplier, speedMultiplier, glowIntensity, trailLength, sparkIntensity;
                    
                    if (sizeCategory < 0.5) {
                        sizeMultiplier = 0.3 + Math.random() * 0.3;
                        speedMultiplier = 1.3 + Math.random() * 0.4;
                        glowIntensity = 0.4;
                        trailLength = 8 + Math.floor(Math.random() * 6);
                        sparkIntensity = 0.6;
                    } else if (sizeCategory < 0.85) {
                        sizeMultiplier = 0.6 + Math.random() * 0.4;
                        speedMultiplier = 1.0 + Math.random() * 0.3;
                        glowIntensity = 0.6;
                        trailLength = 12 + Math.floor(Math.random() * 8);
                        sparkIntensity = 0.8;
                    } else {
                        sizeMultiplier = 1.0 + Math.random() * 0.5;
                        speedMultiplier = 0.7 + Math.random() * 0.3;
                        glowIntensity = 0.8;
                        trailLength = 18 + Math.floor(Math.random() * 10);
                        sparkIntensity = 1.0;
                    }
                    
                    if (isMobile) {
                        sizeMultiplier *= 0.8;
                        trailLength *= 0.7;
                    }
                    
                    const baseAngle = Math.PI / 4;
                    const angleVariation = Math.PI / 12;
                    const angle = baseAngle + (Math.random() - 0.5) * angleVariation * 2;
                    
                    const baseSpeed = (mobileConfig.speed || starsConfig.speed) * speedMultiplier;
                    
                    const star = {
                        x: -80 - Math.random() * 150,
                        y: Math.random() * window.innerHeight * 0.5,
                        vx: Math.cos(angle) * baseSpeed,
                        vy: Math.sin(angle) * baseSpeed,
                        life: 0,
                        maxLife: (800 + Math.random() * 600) / speedMultiplier,
                        color: starsConfig.colors[Math.floor(Math.random() * starsConfig.colors.length)],
                        baseSize: (mobileConfig.baseSize || starsConfig.baseSize) * sizeMultiplier,
                        size: (mobileConfig.baseSize || starsConfig.baseSize) * sizeMultiplier,
                        trail: [],
                        maxTrailLength: Math.floor(trailLength),
                        active: true,
                        brightness: 1.0,
                        glowIntensity: glowIntensity,
                        sizeMultiplier: sizeMultiplier,
                        sparkIntensity: sparkIntensity,
                        
                        twinklePhase: Math.random() * Math.PI * 2,
                        twinkleSpeed: 0.12 + Math.random() * 0.1,
                        twinkleAmplitude: 0.2 + Math.random() * 0.15,
                        
                        hueShift: (Math.random() - 0.5) * 40,
                        hueShiftSpeed: 0.02 + Math.random() * 0.03,
                        currentHue: 0,
                        
                        particleTimer: 0,
                        particleInterval: 80 / speedMultiplier,
                        
                        rotation: 0,
                        rotationSpeed: (0.08 + Math.random() * 0.1) * (sizeMultiplier > 1 ? 0.6 : 1.2),
                        
                        trailOpacity: 0.6 + Math.random() * 0.4,
                        
                        pulsePhase: Math.random() * Math.PI * 2,
                        pulseSpeed: 0.05 + Math.random() * 0.05,
                        pulseAmplitude: 0.1 + Math.random() * 0.1,
                        
                        sparkleTimer: 0,
                        sparkleInterval: 40 + Math.random() * 30
                    };
                    
                    const colorMatch = star.color.match(/hsl\((\d+)/);
                    star.currentHue = colorMatch ? parseInt(colorMatch[1]) : Math.random() * 360;
                    
                    shootingStars.push(star);
                    
                }, i * (180 + Math.random() * 120));
            }
        }

        function createSparks(x, y, baseColor, intensity = 1.0) {
            const sparkCount = Math.floor((2 + Math.random() * 4) * intensity); // TĂNG số lượng
            
            for (let i = 0; i < sparkCount; i++) {
                const spark = getParticle();
                if (!spark) continue;
                
                const hueShift = (Math.random() - 0.5) * 60;
                const brightness = 75 + Math.random() * 25; // TĂNG độ sáng
                const sparkColor = `hsl(${(parseInt(baseColor.match(/\d+/)?.[0] || 200) + hueShift) % 360}, 100%, ${brightness}%)`;
                
                const angle = Math.random() * Math.PI * 2;
                const speed = (0.8 + Math.random() * 2.5) * intensity; // TĂNG tốc độ
                
                spark.x = x + (Math.random() - 0.5) * 12; // TĂNG offset
                spark.y = y + (Math.random() - 0.5) * 12;
                spark.vx = Math.cos(angle) * speed;
                spark.vy = Math.sin(angle) * speed;
                spark.life = 0;
                spark.maxLife = 20 + Math.random() * 30; // TĂNG đời sống
                spark.color = sparkColor;
                spark.size = (0.5 + Math.random() * 0.8) * intensity; // TĂNG kích thước
                spark.active = true;
                spark.fade = 0.92;
                spark.drag = 0.95;
                spark.sparkle = Math.random() > 0.4;
                spark.glitter = Math.random() > 0.6;
                
                spark.twinklePhase = Math.random() * Math.PI * 2;
                spark.twinkleSpeed = 0.2 + Math.random() * 0.15;
            }
        }

        // ====================== HÀM HỖ TRỢ ======================
        function countNearParticles() {
            let count = 0;
            for (let p of particles) {
                if (p.active && p.isNear) count++;
            }
            return count;
        }

        // ====================== HỆ THỐNG ĐIỀU CHỈNH CAO TRÀO ======================
        function updateClimaxSystem(currentTime) {
            if (!startTime) return 1.0;
            
            const elapsed = currentTime - startTime;
            const phases = FIREWORK_CONFIG.adaptiveExplosionRate.phases;
            const totalPhaseTime = phases.buildup + phases.climax + phases.cooldown;
            
            const cycleTime = elapsed % (totalPhaseTime + FIREWORK_CONFIG.adaptiveExplosionRate.loopDelay);
            
            if (cycleTime < phases.buildup) {
                climaxSystem.phase = 'buildup';
                const progress = cycleTime / phases.buildup;
                climaxSystem.climaxIntensity = 1.0 + progress * 0.5; // TĂNG tốc độ tăng
                climaxSystem.soundIntensity = 1.0;
                
            } else if (cycleTime < phases.buildup + phases.climax) {
                if (!climaxSystem.isClimaxActive) {
                    climaxSystem.isClimaxActive = true;
                    climaxSystem.phaseStartTime = currentTime;
                }
                climaxSystem.phase = 'climax';
                
                const climaxProgress = (cycleTime - phases.buildup) / phases.climax;
                
                if (climaxProgress < 0.3) {
                    climaxSystem.climaxIntensity = 1.5 + climaxProgress * 3.0;
                } else if (climaxProgress < 0.7) {
                    climaxSystem.climaxIntensity = 2.4 + (climaxProgress - 0.3) * 3.0;
                } else {
                    climaxSystem.climaxIntensity = 3.6 - (climaxProgress - 0.7) * 2.5;
                }
                
                climaxSystem.soundIntensity = Math.min(2.0, 1.0 + climaxSystem.climaxIntensity * 0.3);
                climaxSystem.bassInterval = Math.max(250, 700 - climaxSystem.climaxIntensity * 180);
                
            } else if (cycleTime < totalPhaseTime) {
                climaxSystem.phase = 'cooldown';
                climaxSystem.isClimaxActive = false;
                
                const cooldownProgress = (cycleTime - (phases.buildup + phases.climax)) / phases.cooldown;
                climaxSystem.climaxIntensity = Math.max(1.0, 1.5 - cooldownProgress * 0.5);
                climaxSystem.soundIntensity = Math.max(1.0, 1.3 - cooldownProgress * 0.3);
                
            } else {
                climaxSystem.phase = 'waiting';
                climaxSystem.climaxIntensity = 1.0;
                climaxSystem.soundIntensity = 1.0;
            }
            
            climaxSystem.climaxMultiplier = 1.0 / climaxSystem.climaxIntensity;
            return climaxSystem.climaxIntensity;
        }

        function getCurrentExplosionInterval() {
            const config = FIREWORK_CONFIG.adaptiveExplosionRate;
            
            if (climaxSystem.phase === 'climax') {
                const min = config.climaxRate.minInterval * climaxSystem.climaxMultiplier;
                const max = config.climaxRate.maxInterval * climaxSystem.climaxMultiplier;
                return Math.random() * (max - min) + min;
            } else {
                const min = config.normalRate.minInterval * climaxSystem.climaxMultiplier;
                const max = config.normalRate.maxInterval * climaxSystem.climaxMultiplier;
                return Math.random() * (max - min) + min;
            }
        }

        // CHỌN LOẠI KHOẢNG CÁCH XEN KẼ
        function getDistanceType() {
            const rand = Math.random();
            let cumulative = 0;
            
            for (let [type, probability] of Object.entries(FIREWORK_CONFIG.distanceDistribution)) {
                cumulative += probability;
                if (rand <= cumulative) {
                    climaxSystem.currentDistanceType = type;
                    return type;
                }
            }
            return 'medium';
        }

        // CHỌN LOẠI PHÁO HOA SINH ĐỘNG
        function getExplosionTypeForPhase() {
            const explosionTypes = climaxSystem.phase === 'climax' 
                ? FIREWORK_CONFIG.explosionTypes.climax 
                : FIREWORK_CONFIG.explosionTypes.normal;
            
            const rand = Math.random();
            let cumulative = 0;
            
            for (let [type, probability] of Object.entries(explosionTypes)) {
                cumulative += probability;
                if (rand <= cumulative) {
                    return type;
                }
            }
            
            return 'peony';
        }

        // ====================== HỆ THỐNG PHÁO HOA MẠNH MẼ ======================
        function createParticlePool() {
            particles = [];
            
            for (let i = 0; i < particlePoolSize; i++) {
                particles.push({
                    x: 0, y: 0,
                    vx: 0, vy: 0,
                    life: 0, maxLife: 0,
                    color: '#fff',
                    size: 1.0,
                    active: false,
                    isNear: false,
                    isRocket: false,
                    isSpecial: false,
                    distanceType: 'medium',
                    
                    // HIỆU ỨNG MỚI
                    trail: false,
                    sparkle: false,
                    glitter: false,
                    colorShift: false,
                    pulse: false,
                    
                    fade: 1.0,
                    gravity: 0.08,
                    drag: 0.97,
                    
                    glowSize: 0,
                    trailLength: 0,
                    twinklePhase: 0,
                    twinkleSpeed: 0,
                    
                    // HIỆU ỨNG THỨ CẤP
                    hasSecondaryExplosion: false,
                    secondaryTimer: 0
                });
            }
        }

        function getParticle() {
            for (let p of particles) {
                if (!p.active) return p;
            }
            
            let oldestParticle = null;
            let oldestLife = 0;
            for (let p of particles) {
                if (p.active) {
                    const lifeRatio = p.life / p.maxLife;
                    if (lifeRatio > oldestLife) {
                        oldestLife = lifeRatio;
                        oldestParticle = p;
                    }
                }
            }
            
            if (oldestParticle && oldestLife > 0.6) {
                oldestParticle.active = false;
                return oldestParticle;
            }
            
            return null;
        }

        function initCanvas() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            canvas.style.display = 'block';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function countActiveParticles() {
            let count = 0;
            for (let p of particles) {
                if (p.active) count++;
            }
            return count;
        }

        // TẠO ROCKET VỚI KHOẢNG CÁCH XEN KẼ
        function createRocket() {
            const activeCount = countActiveParticles();
            if (activeCount > FIREWORK_CONFIG.maxActiveParticles * 0.85) return; // GIẢM ngưỡng để tạo nhiều hơn

            // CHỌN KHOẢNG CÁCH XEN KẼ
            const distanceType = getDistanceType();
            const settings = FIREWORK_CONFIG.distanceSettings[distanceType];
            
            // TĂNG SỐ LƯỢNG ROCKET TRONG BURST
            const climaxConfig = FIREWORK_CONFIG.adaptiveExplosionRate.climaxRate;
            const burstCount = climaxSystem.phase === 'climax' 
                ? climaxConfig.burstCount + Math.floor(Math.random() * 2) // THÊM 0-1 rocket nữa
                : 1;
            
            for (let b = 0; b < burstCount; b++) {
                setTimeout(() => {
                    if (!isRunning || countActiveParticles() > FIREWORK_CONFIG.maxActiveParticles * 0.9) return;
                    
                    const x = Math.random() * window.innerWidth;
                    const yStart = window.innerHeight;
                    const hue = Math.random() * 360;
                    
                    // BIẾN THỂ MÀU SẮC
                    const hueVariation = distanceType === 'near' ? 20 : 
                                       distanceType === 'medium' ? 30 : 40;
                    const baseHue = (hue + (Math.random() - 0.5) * hueVariation) % 360;
                    
                    const p = getParticle();
                    if (p) {
                        p.x = x;
                        p.y = yStart;
                        p.vx = (Math.random() - 0.5) * 1.5 * climaxSystem.climaxIntensity; // TĂNG độ ngẫu nhiên
                        p.vy = -(12 + Math.random() * 7) * FIREWORK_CONFIG.rocketSpeedMultiplier * settings.speedMultiplier * climaxSystem.climaxIntensity; // TĂNG tốc độ
                        p.life = 0;
                        p.maxLife = 45 + Math.random() * 20; // TĂNG đời sống
                        p.color = `hsl(${baseHue}, 100%, ${distanceType === 'near' ? 85 : (distanceType === 'medium' ? 75 : 65)}%)`;
                        p.size = (1.4 + Math.random() * 0.8) * FIREWORK_CONFIG.particleSizeMultiplier * settings.sizeMultiplier * climaxSystem.climaxIntensity; // TĂNG kích thước
                        p.active = true;
                        p.isRocket = true;
                        p.isNear = distanceType === 'near';
                        p.distanceType = distanceType;
                        p.glowSize = p.size * 2.5 * climaxSystem.climaxIntensity * settings.glowIntensity; // TĂNG glow
                        p.trail = Math.random() < FIREWORK_CONFIG.specialEffects.trailChance;
                        p.sparkle = Math.random() < settings.sparkleChance;
                        
                        // HIỆU ỨNG ĐẶC BIỆT CHO PHÁO GẦN
                        if (distanceType === 'near') {
                            p.glitter = Math.random() < FIREWORK_CONFIG.specialEffects.glitterChance;
                            p.colorShift = Math.random() < FIREWORK_CONFIG.specialEffects.colorShiftChance;
                            p.pulse = Math.random() < FIREWORK_CONFIG.specialEffects.pulseChance;
                            p.trailLength = 6 + Math.floor(Math.random() * 4);
                        }
                        
                        p.isSpecial = climaxSystem.phase === 'climax' && Math.random() > 0.7; // TĂNG tỷ lệ đặc biệt
                    }

                    // TẠO TRAIL ĐẸP HƠN
                    if (p && p.trail) {
                        const trailInterval = setInterval(() => {
                            if (!isRunning || !p || !p.active) {
                                clearInterval(trailInterval);
                                return;
                            }
                            
                            const trail = getParticle();
                            if (trail) {
                                trail.x = p.x + (Math.random() - 0.5) * 3;
                                trail.y = p.y + (Math.random() - 0.5) * 3;
                                trail.vx = p.vx * 0.2 + (Math.random() - 0.5) * 0.6;
                                trail.vy = p.vy * 0.1 + Math.random() * 1.2;
                                trail.life = 0;
                                trail.maxLife = 25 + Math.random() * 20;
                                trail.color = p.color.replace('%)', '%, 0.8)').replace('hsl', 'hsla');
                                trail.size = p.size * 0.5;
                                trail.active = true;
                                trail.fade = 0.85;
                                trail.drag = 0.93;
                                trail.distanceType = distanceType;
                            }
                        }, 30); // TĂNG tần suất trail
                    }

                    // LÊN LỊCH NỔ
                    setTimeout(() => {
                        if (!isRunning) return;
                        
                        const minHeight = settings.minHeight * window.innerHeight;
                        const maxHeight = settings.maxHeight * window.innerHeight;
                        const yExplode = minHeight + Math.random() * (maxHeight - minHeight);
                        
                        const explosionType = getExplosionTypeForPhase();
                        createEnhancedExplosion(x, yExplode, baseHue, distanceType, explosionType);
                        
                        // ÂM THANH
                        if (climaxSystem.phase === 'climax' || Math.random() > 0.4) { // TĂNG tần suất âm thanh
                            playBassSound();
                        }
                    }, (distanceType === 'near' ? 400 : (distanceType === 'medium' ? 600 : 800)) + 
                       Math.random() * 300 / climaxSystem.climaxIntensity); // GIẢM thời gian
                    
                }, b * (climaxConfig.burstDelay || 50));
            }
        }

        // TẠO VỤ NỔ SINH ĐỘNG VỚI NHIỀU HẠT
        function createEnhancedExplosion(x, y, baseHue, distanceType, explosionType) {
            const activeCount = countActiveParticles();
            if (activeCount > FIREWORK_CONFIG.maxActiveParticles * 0.8) return;

            const settings = FIREWORK_CONFIG.distanceSettings[distanceType];
            const intensityMultiplier = climaxSystem.climaxIntensity;
            
            // TĂNG SỐ LƯỢNG HẠT CƠ BẢN
            const baseParticleMultiplier = settings.particleMultiplier || 1.0;
            const particleMultiplier = baseParticleMultiplier * (0.9 + intensityMultiplier * 0.5);
            
            switch(explosionType) {
                case 'peony':
                    createPeonyExplosion(x, y, baseHue, distanceType, settings, particleMultiplier);
                    break;
                case 'chrysanthemum':
                    createChrysanthemumExplosion(x, y, baseHue, distanceType, settings, particleMultiplier);
                    break;
                case 'double_ring':
                    createDoubleRingExplosion(x, y, baseHue, distanceType, settings, particleMultiplier);
                    break;
                case 'spiral':
                    createSpiralExplosion(x, y, baseHue, distanceType, settings, particleMultiplier);
                    break;
                case 'heart':
                    createHeartExplosion(x, y, baseHue, distanceType, settings, particleMultiplier);
                    break;
                case 'special':
                    createSpecialExplosion(x, y, baseHue, distanceType, settings, particleMultiplier);
                    break;
                default:
                    createPeonyExplosion(x, y, baseHue, distanceType, settings, particleMultiplier);
            }
        }

        // PEONY EXPLOSION - CẢI TIẾN
        function createPeonyExplosion(x, y, baseHue, distanceType, settings, multiplier = 1.0) {
            const numParticles = Math.floor(((distanceType === 'near' ? 120 : (distanceType === 'medium' ? 100 : 90)) + 
                                            Math.random() * 80) * multiplier); // TĂNG số lượng
            
            for (let i = 0; i < numParticles; i++) {
                const p = getParticle();
                if (!p) continue;
                
                const angle = Math.random() * Math.PI * 2;
                const speed = (3 + Math.random() * 4.5) * FIREWORK_CONFIG.explosionSpeedMultiplier * settings.speedMultiplier * climaxSystem.climaxIntensity;
                
                p.x = x;
                p.y = y;
                p.vx = Math.cos(angle) * speed;
                p.vy = Math.sin(angle) * speed;
                p.life = 0;
                p.maxLife = (distanceType === 'near' ? 85 : (distanceType === 'medium' ? 75 : 65)) + Math.random() * 60;
                
                // MÀU SẮC PHONG PHÚ HƠN
                const hueShift = (Math.random() - 0.5) * 60;
                const saturation = 95 + Math.random() * 5;
                const brightness = (distanceType === 'near' ? 80 : (distanceType === 'medium' ? 70 : 60)) + Math.random() * 25;
                p.color = `hsl(${(baseHue + hueShift) % 360}, ${saturation}%, ${brightness}%)`;
                
                p.size = (1.3 + Math.random() * 0.9) * FIREWORK_CONFIG.particleSizeMultiplier * settings.sizeMultiplier * climaxSystem.climaxIntensity;
                p.active = true;
                p.distanceType = distanceType;
                
                // THÊM HIỆU ỨNG
                p.trail = Math.random() < FIREWORK_CONFIG.specialEffects.trailChance;
                p.sparkle = Math.random() < FIREWORK_CONFIG.specialEffects.sparkleChance;
                p.glitter = Math.random() < FIREWORK_CONFIG.specialEffects.glitterChance;
                p.colorShift = Math.random() < 0.3;
                p.pulse = Math.random() < FIREWORK_CONFIG.specialEffects.pulseChance;
                
                p.gravity = 0.09;
                p.drag = 0.98;
                p.glowSize = p.size * (distanceType === 'near' ? 2.8 : (distanceType === 'medium' ? 2.3 : 1.8)) * climaxSystem.climaxIntensity;
                p.twinklePhase = Math.random() * Math.PI * 2;
                p.twinkleSpeed = 0.08 + Math.random() * 0.12;
                
                // NỔ THỨ CẤP
                if (Math.random() < FIREWORK_CONFIG.specialEffects.secondaryExplosionChance) {
                    p.hasSecondaryExplosion = true;
                    p.secondaryTimer = p.maxLife * 0.6;
                }
            }
        }

        // CHRYSANTHEMUM EXPLOSION - CẢI TIẾN
        function createChrysanthemumExplosion(x, y, baseHue, distanceType, settings, multiplier = 1.0) {
            const rays = Math.floor((28 + Math.random() * 22) * multiplier); // TĂNG số tia
            const particlesPerRay = Math.floor((9 + Math.random() * 7) * multiplier); // TĂNG số hạt mỗi tia
            
            for (let i = 0; i < rays; i++) {
                const angle = (Math.PI * 2 * i) / rays;
                const rayHueShift = (i / rays) * 120; // Gradient màu theo tia
                
                for (let j = 0; j < particlesPerRay; j++) {
                    const p = getParticle();
                    if (!p) continue;
                    
                    const speed = (6 + j * 0.9 + Math.random() * 2.2) * FIREWORK_CONFIG.explosionSpeedMultiplier * settings.speedMultiplier * climaxSystem.climaxIntensity;
                    
                    p.x = x;
                    p.y = y;
                    p.vx = Math.cos(angle) * speed;
                    p.vy = Math.sin(angle) * speed;
                    p.life = 0;
                    p.maxLife = (distanceType === 'near' ? 80 : (distanceType === 'medium' ? 70 : 60)) + Math.random() * 45;
                    
                    const hueShift = (Math.random() - 0.5) * 40 + rayHueShift;
                    const brightness = (distanceType === 'near' ? 75 : (distanceType === 'medium' ? 65 : 55)) + Math.random() * 30;
                    p.color = `hsl(${(baseHue + hueShift) % 360}, 100%, ${brightness}%)`;
                    
                    p.size = (1.0 + Math.random() * 0.8) * FIREWORK_CONFIG.particleSizeMultiplier * settings.sizeMultiplier * climaxSystem.climaxIntensity;
                    p.active = true;
                    p.distanceType = distanceType;
                    p.trail = true;
                    p.trailLength = (distanceType === 'near' ? 5 : (distanceType === 'medium' ? 4 : 3)) + Math.random() * 3;
                    p.sparkle = j % 3 === 0;
                    p.gravity = 0.08;
                    p.drag = 0.985;
                    p.glowSize = p.size * (distanceType === 'near' ? 2.2 : (distanceType === 'medium' ? 1.9 : 1.5)) * climaxSystem.climaxIntensity;
                }
            }
        }

        // VÒNG KÉP - HIỆU ỨNG MỚI
        function createDoubleRingExplosion(x, y, baseHue, distanceType, settings, multiplier = 1.0) {
            const numRings = 2;
            const particlesPerRing = Math.floor((40 + Math.random() * 30) * multiplier);
            
            for (let ring = 0; ring < numRings; ring++) {
                const ringHue = (baseHue + ring * 180) % 360; // Màu đối lập cho vòng thứ 2
                
                for (let i = 0; i < particlesPerRing; i++) {
                    const p = getParticle();
                    if (!p) continue;
                    
                    const angle = (Math.PI * 2 * i) / particlesPerRing;
                    const ringRadius = (ring + 1) * 3; // Vòng ngoài lớn hơn
                    const speed = (5 + ring * 0.8) * FIREWORK_CONFIG.explosionSpeedMultiplier * settings.speedMultiplier * climaxSystem.climaxIntensity;
                    
                    p.x = x + Math.cos(angle) * ringRadius;
                    p.y = y + Math.sin(angle) * ringRadius;
                    p.vx = Math.cos(angle) * speed;
                    p.vy = Math.sin(angle) * speed;
                    p.life = 0;
                    p.maxLife = (distanceType === 'near' ? 75 : (distanceType === 'medium' ? 65 : 55)) + Math.random() * 50;
                    p.color = `hsl(${ringHue}, 100%, ${(distanceType === 'near' ? 75 : (distanceType === 'medium' ? 65 : 55)) + Math.random() * 25}%)`;
                    p.size = (1.1 + Math.random() * 0.7) * FIREWORK_CONFIG.particleSizeMultiplier * settings.sizeMultiplier * climaxSystem.climaxIntensity;
                    p.active = true;
                    p.distanceType = distanceType;
                    p.trail = true;
                    p.sparkle = true;
                    p.gravity = 0.07;
                    p.drag = 0.985;
                    p.glowSize = p.size * 2.5 * climaxSystem.climaxIntensity;
                    
                    // Vòng ngoài quay ngược chiều
                    if (ring === 1) {
                        p.vx *= -0.7;
                        p.vy *= -0.7;
                    }
                }
            }
        }

        // XOẮN ỐC - HIỆU ỨNG MỚI
        function createSpiralExplosion(x, y, baseHue, distanceType, settings, multiplier = 1.0) {
            const spirals = 3;
            const particlesPerSpiral = Math.floor((25 + Math.random() * 20) * multiplier);
            
            for (let s = 0; s < spirals; s++) {
                const spiralDirection = s % 2 === 0 ? 1 : -1; // Đảo chiều xoắn
                const spiralHue = (baseHue + s * 120) % 360;
                
                for (let i = 0; i < particlesPerSpiral; i++) {
                    const p = getParticle();
                    if (!p) continue;
                    
                    const spiralProgress = i / particlesPerSpiral;
                    const angle = (Math.PI * 2 * spiralProgress * 3) + (s * Math.PI * 2 / spirals);
                    const radius = 2 + spiralProgress * 8;
                    const speed = (4 + Math.random() * 3) * FIREWORK_CONFIG.explosionSpeedMultiplier * settings.speedMultiplier * climaxSystem.climaxIntensity;
                    
                    p.x = x + Math.cos(angle) * radius;
                    p.y = y + Math.sin(angle) * radius;
                    p.vx = Math.cos(angle + Math.PI/2 * spiralDirection) * speed;
                    p.vy = Math.sin(angle + Math.PI/2 * spiralDirection) * speed;
                    p.life = 0;
                    p.maxLife = (distanceType === 'near' ? 70 : (distanceType === 'medium' ? 60 : 50)) + Math.random() * 40;
                    p.color = `hsl(${spiralHue}, 100%, ${(distanceType === 'near' ? 70 : (distanceType === 'medium' ? 60 : 50)) + Math.random() * 20}%)`;
                    p.size = (0.9 + Math.random() * 0.6) * FIREWORK_CONFIG.particleSizeMultiplier * settings.sizeMultiplier * climaxSystem.climaxIntensity;
                    p.active = true;
                    p.distanceType = distanceType;
                    p.trail = true;
                    p.gravity = 0.06;
                    p.drag = 0.99;
                    p.glowSize = p.size * 2.0 * climaxSystem.climaxIntensity;
                }
            }
        }

        // HÌNH TIM - HIỆU ỨNG ĐẶC BIỆT
        function createHeartExplosion(x, y, baseHue, distanceType, settings, multiplier = 1.0) {
            const particles = Math.floor((60 + Math.random() * 40) * multiplier);
            
            for (let i = 0; i < particles; i++) {
                const p = getParticle();
                if (!p) continue;
                
                // Phương trình hình tim
                const t = (Math.PI * 2 * i) / particles;
                const heartX = 16 * Math.pow(Math.sin(t), 3);
                const heartY = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                
                const scale = 0.15 * climaxSystem.climaxIntensity;
                const speed = (3 + Math.random() * 2.5) * FIREWORK_CONFIG.explosionSpeedMultiplier * settings.speedMultiplier;
                
                p.x = x + heartX * scale;
                p.y = y - heartY * scale; // Trừ y vì canvas y tăng xuống dưới
                p.vx = (Math.random() - 0.5) * speed;
                p.vy = (Math.random() - 0.5) * speed;
                p.life = 0;
                p.maxLife = (distanceType === 'near' ? 90 : (distanceType === 'medium' ? 80 : 70)) + Math.random() * 50;
                
                // Màu đỏ/pink cho hình tim
                const heartHue = 340 + Math.random() * 20;
                p.color = `hsl(${heartHue}, 100%, ${(distanceType === 'near' ? 75 : (distanceType === 'medium' ? 65 : 55)) + Math.random() * 25}%)`;
                
                p.size = (1.0 + Math.random() * 0.8) * FIREWORK_CONFIG.particleSizeMultiplier * settings.sizeMultiplier * climaxSystem.climaxIntensity;
                p.active = true;
                p.distanceType = distanceType;
                p.trail = true;
                p.sparkle = true;
                p.gravity = 0.05;
                p.drag = 0.99;
                p.glowSize = p.size * 2.8 * climaxSystem.climaxIntensity;
            }
        }

        // PHÁO ĐẶC BIỆT
        function createSpecialExplosion(x, y, baseHue, distanceType, settings, multiplier = 1.0) {
            // Kết hợp nhiều hiệu ứng
            createPeonyExplosion(x, y, baseHue, distanceType, settings, multiplier * 0.6);
            
            // Thêm vòng
            setTimeout(() => {
                if (isRunning) {
                    createDoubleRingExplosion(x, y, (baseHue + 180) % 360, distanceType, settings, multiplier * 0.4);
                }
            }, 200);
            
            // Thêm xoắn ốc
            setTimeout(() => {
                if (isRunning) {
                    createSpiralExplosion(x, y, (baseHue + 90) % 360, distanceType, settings, multiplier * 0.3);
                }
            }, 400);
        }

        // ====================== RENDER SINH ĐỘNG ======================
        function renderParticle(p, ctx, progress) {
            let alpha = p.isRocket ? (1 - progress ** 1.8) : (1 - progress ** 1.4);
            
            if (climaxSystem.phase === 'climax') {
                alpha *= 1.15;
            }
            
            // HIỆU ỨNG MÀU SẮC
            let renderColor = p.color;
            if (p.colorShift) {
                const hueShift = Math.sin(p.life * 0.1) * 60;
                renderColor = renderColor.replace(/hsl\(\d+/, match => 
                    `hsl(${(parseInt(match.match(/\d+/)[0]) + hueShift) % 360}`);
            }
            
            // HIỆU ỨNG PULSE
            if (p.pulse) {
                const pulse = 0.8 + Math.sin(p.life * 0.2) * 0.2;
                alpha *= pulse;
            }
            
            // HIỆU ỨNG TWINKLE
            if (p.sparkle) {
                const twinkle = 0.6 + Math.sin(p.twinklePhase + p.life * 0.3) * 0.4;
                alpha *= twinkle;
            }
            
            const fadeAlpha = p.fade !== undefined ? p.fade : 1.0;
            alpha *= fadeAlpha;
            
            // GLOW EFFECT
            if (p.glowSize && progress < 0.6 && alpha > 0.3) {
                const glowAlpha = alpha * (1 - progress * 1.5) * 0.6;
                ctx.shadowBlur = p.glowSize * (1 - progress * 0.7);
                ctx.shadowColor = renderColor.replace(')', `, ${glowAlpha})`).replace('hsl', 'hsla');
            }
            
            // TRAIL EFFECT
            if (p.trail && p.trailLength && progress < 0.4 && !p.isRocket) {
                ctx.shadowBlur = p.trailLength * (1 - progress * 2);
                ctx.shadowColor = renderColor;
            }
            
            // VẼ PARTICLE
            ctx.fillStyle = renderColor.replace(')', `, ${alpha})`).replace('hsl', 'hsla');
            ctx.beginPath();
            
            let currentSize = p.size;
            if (p.isRocket) {
                currentSize *= 1.2;
            } else {
                currentSize *= (1 - progress * 0.4);
                
                // HIỆU ỨNG GLITTER
                if (p.glitter && alpha > 0.5) {
                    const glitterSize = currentSize * (0.8 + Math.sin(p.life * 0.5) * 0.4);
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, glitterSize * 0.3, 0, Math.PI * 2);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.globalAlpha = alpha * 0.7;
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                }
            }
            
            ctx.arc(p.x, p.y, currentSize, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.shadowBlur = 0;
            
            // XỬ LÝ NỔ THỨ CẤP
            if (p.hasSecondaryExplosion && p.life >= p.secondaryTimer && p.active) {
                p.hasSecondaryExplosion = false;
                createSparks(p.x, p.y, p.color, 1.5);
            }
        }

        // ====================== ANIMATE MẠNH MẼ ======================
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let fps = 60;

        function animate(time) {
            if (!isRunning && !showShootingStars) return;
            
            frameCount++;
            if (time - lastFpsUpdate > 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFpsUpdate = time;
                
                if (fps < 30 && isRunning) {
                    climaxSystem.climaxIntensity *= 0.95;
                } else if (fps > 55 && isRunning) {
                    climaxSystem.climaxIntensity *= 1.02;
                }
            }
            
            const targetFrameTime = 1000 / FIREWORK_CONFIG.targetFPS;
            const delta = lastTime === 0 ? 1 : Math.min((time - lastTime) / targetFrameTime, 2.5);
            lastTime = time;

            // UPDATE CLIMAX SYSTEM
            const climaxIntensity = updateClimaxSystem(time);
            
            // CLEAR CANVAS
            let clearAlpha = 0.1;
            if (climaxIntensity > 2.0) {
                clearAlpha = Math.max(0.04, 0.1 - (climaxIntensity - 2.0) * 0.02);
            }
            if (isMobile) clearAlpha += 0.05;
            
            ctx.fillStyle = `rgba(0,0,0,${clearAlpha})`;
            ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

            // UPDATE PARTICLES
            ctx.save();
            
            let renderedCount = 0;
            const maxRenderPerFrame = isMobile ? 1000 : 1500;
            const activeParticles = [];
            
            // COLLECT ACTIVE PARTICLES FIRST
            for (let p of particles) {
                if (p.active) activeParticles.push(p);
            }
            
            // RENDER IN OPTIMAL ORDER (NEAR FIRST)
            activeParticles.sort((a, b) => {
                if (a.distanceType === 'near' && b.distanceType !== 'near') return -1;
                if (b.distanceType === 'near' && a.distanceType !== 'near') return 1;
                return 0;
            });
            
            for (let p of activeParticles) {
                if (renderedCount >= maxRenderPerFrame) {
                    p.active = false;
                    continue;
                }
                
                // UPDATE POSITION
                p.x += p.vx * delta;
                p.y += p.vy * delta;

                if (!p.isRocket) {
                    p.vy += p.gravity * delta * climaxIntensity;
                    p.vx *= Math.pow(p.drag, delta);
                    p.vy *= Math.pow(p.drag, delta);
                    
                    // UPDATE TWINKLE
                    if (p.twinkleSpeed) {
                        p.twinklePhase += p.twinkleSpeed * delta;
                    }
                }

                p.life += delta;
                if (p.life >= p.maxLife) {
                    p.active = false;
                    continue;
                }

                const progress = p.life / p.maxLife;
                renderParticle(p, ctx, progress);
                renderedCount++;
            }
            ctx.restore();

            // CREATE NEW ROCKETS
            if (time > nextExplosionTime) {
                const interval = getCurrentExplosionInterval();
                
                // TĂNG SỐ LƯỢNG ROCKET Ở CAO TRÀO
                let explosionCount = 1;
                if (climaxSystem.phase === 'climax') {
                    explosionCount = 2 + Math.floor(climaxIntensity / 2);
                }
                
                for (let i = 0; i < explosionCount; i++) {
                    setTimeout(() => {
                        if (isRunning && countActiveParticles() < FIREWORK_CONFIG.maxActiveParticles * 0.75) {
                            createRocket();
                        }
                    }, i * 50);
                }
                
                nextExplosionTime = time + interval;
            }

            requestAnimationFrame(animate);
        }

        // ====================== KHỞI ĐỘNG ======================
        const btn = document.getElementById('startBtn');
        
        async function start() {
            btn.classList.add('clicked');
            
            setTimeout(async () => {
                try {
                    await initBackgroundMusic();
                    
                    initAudioSystem();
                    playBackgroundMusic();
                    
                    initCanvas();
                    createParticlePool();

                    if (masterGain) {
                        masterGain.gain.setValueAtTime(0.001, audioCtx?.currentTime || 0);
                        if (audioCtx) {
                            masterGain.gain.exponentialRampToValueAtTime(SOUND_CONFIG.masterVolume, audioCtx.currentTime + 1.5);
                        }
                    }

                    isRunning = true;
                    startTime = performance.now();
                    lastTime = startTime;
                    
                    // BẮT ĐẦU MẠNH MẼ
                    nextExplosionTime = startTime + 300;
                    nextSoundTime = startTime + 500;

                    requestAnimationFrame(animate);
                    
                } catch (error) {
                    console.error("Lỗi khởi tạo:", error);
                    initCanvas();
                    createParticlePool();
                    isRunning = true;
                    startTime = performance.now();
                    lastTime = startTime;
                    nextExplosionTime = startTime + 300;
                    requestAnimationFrame(animate);
                }
            }, 800);
        }

        // ====================== EVENT LISTENERS ======================
        window.addEventListener('DOMContentLoaded', () => {
            initCanvas();
            canvas.style.display = 'block';
        });
        
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            start();
        }, { passive: false });
        
        btn.addEventListener('pointerdown', start);
        
        window.addEventListener('resize', () => {
            initCanvas();
        });
        
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                isRunning = false;
                if (backgroundMusic) {
                    backgroundMusic.pause();
                }
            } else if (startTime > 0) {
                isRunning = true;
                if (backgroundMusic) {
                    playBackgroundMusic();
                }
                lastTime = performance.now();
                requestAnimationFrame(animate);
            }
        });
    </script>
</body>
</html>
