<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ph√°o Hoa</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            font-family: system-ui, sans-serif;
            color: #fff;
        }
        #canvas {
            position: absolute;
            inset: 0;
            z-index: 1;
            display: none;
        }
        #startBtn {
            position: relative;
            z-index: 10;
            padding: 18px 48px;
            font-size: 28px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(102,126,234,0.4);
            transition: all 0.2s ease;
        }
        #startBtn:active {
            transform: scale(0.92);
            box-shadow: 0 4px 16px rgba(102,126,234,0.3);
        }
        #orientationWarning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        #orientationWarning h2 {
            color: #ffcc00;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }
        #orientationWarning p {
            color: #fff;
            font-size: 16px;
            margin-bottom: 30px;
            max-width: 90%;
            line-height: 1.5;
        }
        #openInBrowser {
            margin-top: 20px;
            padding: 12px 24px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.2s ease;
        }
        #openInBrowser:active {
            transform: scale(0.95);
        }
        .phone-icon {
            font-size: 50px;
            margin: 20px;
        }
        .browser-icons {
            font-size: 40px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div id="orientationWarning">
        <h2>üì± TR·∫¢I NGHI·ªÜM T·ªêT NH·∫§T TR√äN TR√åNH DUY·ªÜT üì±</h2>
        <p>Tr√¨nh duy·ªát trong Zalo kh√¥ng h·ªó tr·ª£ xoay ngang v√† c√≥ th·ªÉ b·ªã gi·ªõi h·∫°n √¢m thanh.</p>
        
        <div class="phone-icon">üéÜ‚ú®</div>
        
        <p>ƒê·ªÉ c√≥ tr·∫£i nghi·ªám ph√°o hoa tuy·ªát v·ªùi nh·∫•t:</p>
        
        <div class="browser-icons">
            <span title="Chrome">üåê</span>
            <span title="Safari">üß≠</span>
            <span title="Firefox">ü¶ä</span>
        </div>
        
        <p style="color: #ffcc00; font-size: 14px;">
            <strong>Khuy·∫øn ngh·ªã:</strong> M·ªü link n√†y trong tr√¨nh duy·ªát m·∫∑c ƒë·ªãnh c·ªßa ƒëi·ªán tho·∫°i
        </p>
        
        <button id="openInBrowser">M·ªû TRONG TR√åNH DUY·ªÜT</button>
        
        <p style="color: #aaa; font-size: 12px; margin-top: 20px;">
            Ho·∫∑c ti·∫øp t·ª•c trong Zalo (c√≥ th·ªÉ b·ªã gi·ªõi h·∫°n)
        </p>
    </div>
    
    <button id="startBtn">B·∫ÆT ƒê·∫¶U</button>
    <canvas id="canvas"></canvas>

    <script>
        // C·∫§U H√åNH PH√ÅO HOA - T·ªêI ∆ØU CHO MOBILE/IN-APP BROWSERS
        const FIREWORK_CONFIG = {
            maxParticlesPerExplosion: 60,           // GI·∫¢M nhi·ªÅu h∆°n cho in-app browsers
            maxIntensity: 2.0,                      // GI·∫¢M c∆∞·ªùng ƒë·ªô
            explosionIntervalMin: 1800,             // TƒÇNG kho·∫£ng c√°ch h∆°n n·ªØa
            explosionIntervalMax: 3000,
            targetFPS: 45,                          // GI·∫¢M FPS cho hi·ªáu su·∫•t
            maxActiveParticles: 800,                // GI·∫¢M nhi·ªÅu particle h∆°n
            particleSizeMultiplier: 0.6,            // GI·∫¢M k√≠ch th∆∞·ªõc nhi·ªÅu h∆°n
            rocketSpeedMultiplier: 0.7,
            explosionSpeedMultiplier: 0.6
        };

        // ƒê∆Ø·ªúNG D·∫™N FILE NH·∫†C
        const MUSIC_FILE = 'phaobong.mp3';

        let canvas, ctx, backgroundMusic;
        let particles = [];
        let particlePoolSize = FIREWORK_CONFIG.maxParticlesPerExplosion * 20;
        let lastTime = 0, startTime = 0;
        let isRunning = false;
        let nextExplosionTime = 0;
        let isMusicLoaded = false;
        let isMusicPlaying = false;
        let isInZaloBrowser = false;

        // ====================== PH√ÅT HI·ªÜN ZALO/IN-APP BROWSER ======================
        function detectInAppBrowser() {
            const userAgent = navigator.userAgent.toLowerCase();
            
            // Ki·ªÉm tra c√°c in-app browsers ph·ªï bi·∫øn
            const isInAppBrowser = 
                userAgent.includes('zalo') ||
                userAgent.includes('fbios') ||
                userAgent.includes('fban') ||
                userAgent.includes('fbav') ||
                userAgent.includes('messenger') ||
                userAgent.includes('line') ||
                userAgent.includes('twitter') ||
                userAgent.includes('whatsapp') ||
                (window.MessengerExtensions !== undefined) ||
                (window.FB !== undefined && window.FB.__externalCallbacks) ||
                (document.referrer && document.referrer.includes('zalo'));
            
            isInZaloBrowser = isInAppBrowser;
            
            // N·∫øu l√† in-app browser, hi·ªÉn th·ªã c·∫£nh b√°o
            if (isInAppBrowser) {
                const warning = document.getElementById('orientationWarning');
                const startBtn = document.getElementById('startBtn');
                
                warning.style.display = 'flex';
                startBtn.style.display = 'none';
                
                return true;
            }
            
            return false;
        }

        // ====================== M·ªû TRONG TR√åNH DUY·ªÜT ======================
        function setupOpenInBrowser() {
            const openBtn = document.getElementById('openInBrowser');
            const startBtn = document.getElementById('startBtn');
            const warning = document.getElementById('orientationWarning');
            
            openBtn.addEventListener('click', function() {
                // L·∫•y URL hi·ªán t·∫°i
                const currentUrl = window.location.href;
                
                // T·∫°o URL ƒë·ªÉ m·ªü trong tr√¨nh duy·ªát
                const browserUrl = currentUrl;
                
                // Th·ª≠ m·ªü trong tr√¨nh duy·ªát
                try {
                    // Ph∆∞∆°ng ph√°p 1: window.open (c√≥ th·ªÉ b·ªã ch·∫∑n)
                    window.open(browserUrl, '_system');
                    
                    // Ph∆∞∆°ng ph√°p 2: Chuy·ªÉn h∆∞·ªõng sau 1 gi√¢y n·∫øu kh√¥ng th√†nh c√¥ng
                    setTimeout(() => {
                        window.location.href = browserUrl;
                    }, 1000);
                    
                } catch (e) {
                    // Ph∆∞∆°ng ph√°p 3: Fallback ƒë∆°n gi·∫£n
                    window.location.href = browserUrl;
                }
            });
            
            // N√∫t b·∫Øt ƒë·∫ßu trong c·∫£nh b√°o (cho nh·ªØng ng∆∞·ªùi mu·ªën ti·∫øp t·ª•c trong app)
            const continueInApp = document.createElement('button');
            continueInApp.textContent = 'TI·∫æP T·ª§C TRONG ·ª®NG D·ª§NG';
            continueInApp.style.cssText = `
                margin-top: 10px;
                padding: 10px 20px;
                font-size: 14px;
                color: #aaa;
                background: transparent;
                border: 1px solid #555;
                border-radius: 20px;
                cursor: pointer;
            `;
            
            continueInApp.addEventListener('click', function() {
                warning.style.display = 'none';
                startBtn.style.display = 'block';
            });
            
            warning.appendChild(continueInApp);
        }

        // ====================== H·ªÜ TH·ªêNG NH·∫†C N·ªÄN (T∆Ø∆†NG TH√çCH T·ªêT H∆†N) ======================
        function initBackgroundMusic() {
            return new Promise((resolve, reject) => {
                try {
                    // Ki·ªÉm tra xem tr√¨nh duy·ªát c√≥ h·ªó tr·ª£ audio kh√¥ng
                    if (typeof Audio === 'undefined') {
                        console.warn("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Audio API");
                        resolve(false); // Kh√¥ng reject, ch·ªâ kh√¥ng d√πng nh·∫°c
                        return;
                    }
                    
                    backgroundMusic = new Audio();
                    backgroundMusic.src = MUSIC_FILE;
                    backgroundMusic.loop = true;
                    backgroundMusic.volume = 0.5; // √Çm l∆∞·ª£ng th·∫•p h∆°n cho in-app browsers
                    backgroundMusic.preload = 'auto';
                    
                    // Gi·∫£m y√™u c·∫ßu user interaction cho in-app browsers
                    backgroundMusic.autoplay = false;
                    
                    backgroundMusic.addEventListener('loadeddata', () => {
                        isMusicLoaded = true;
                        console.log("‚úÖ Nh·∫°c ƒë√£ t·∫£i xong");
                        resolve(true);
                    });
                    
                    backgroundMusic.addEventListener('error', (e) => {
                        console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i nh·∫°c, ti·∫øp t·ª•c kh√¥ng nh·∫°c");
                        resolve(false); // Kh√¥ng reject, ti·∫øp t·ª•c kh√¥ng nh·∫°c
                    });
                    
                    // Th·ª≠ t·∫£i nh·∫°c
                    backgroundMusic.load().catch(() => {
                        resolve(false); // Ti·∫øp t·ª•c kh√¥ng nh·∫°c n·∫øu l·ªói
                    });
                    
                } catch (e) {
                    console.warn("‚ö†Ô∏è L·ªói kh·ªüi t·∫°o nh·∫°c:", e);
                    resolve(false); // Ti·∫øp t·ª•c kh√¥ng nh·∫°c
                }
            });
        }

        function playBackgroundMusic() {
            if (!backgroundMusic || !isMusicLoaded || isInZaloBrowser) {
                return false; // Kh√¥ng ph√°t nh·∫°c trong Zalo ƒë·ªÉ tr√°nh l·ªói
            }
            
            try {
                // Trong in-app browsers, c·∫ßn user interaction tr·ª±c ti·∫øp
                const playPromise = backgroundMusic.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ t·ª± ƒë·ªông ph√°t nh·∫°c:", error);
                        // Kh√¥ng b√°o l·ªói, ch·ªâ kh√¥ng ph√°t nh·∫°c
                    });
                }
                
                return true;
            } catch (e) {
                console.warn("‚ö†Ô∏è L·ªói ph√°t nh·∫°c:", e);
                return false;
            }
        }

        // ====================== H·ªÜ TH·ªêNG PH√ÅO HOA (ƒê∆†N GI·∫¢N H∆†N) ======================
        function createParticlePool() {
            particles = [];
            for (let i = 0; i < particlePoolSize; i++) {
                particles.push({
                    x: 0, y: 0,
                    vx: 0, vy: 0,
                    life: 0, maxLife: 0,
                    color: '#fff',
                    size: 1.2 * FIREWORK_CONFIG.particleSizeMultiplier,
                    active: false
                });
            }
        }

        function getParticle() {
            // T√¨m particle kh√¥ng active
            for (let p of particles) {
                if (!p.active) return p;
            }
            
            // N·∫øu kh√¥ng c√≤n, t√°i s·ª≠ d·ª•ng particle c≈© nh·∫•t
            let oldestParticle = null;
            let oldestLife = 0;
            
            for (let p of particles) {
                if (p.active && p.life > oldestLife) {
                    oldestLife = p.life;
                    oldestParticle = p;
                }
            }
            
            if (oldestParticle) {
                oldestParticle.active = false;
                return oldestParticle;
            }
            
            return null;
        }

        function initCanvas() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            // S·ª≠ d·ª•ng DPR th·∫•p cho hi·ªáu su·∫•t
            const dpr = Math.min(window.devicePixelRatio || 1, 1.0);
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            canvas.style.width = `${window.innerWidth}px`;
            canvas.style.height = `${window.innerHeight}px`;
            
            if (dpr !== 1) {
                ctx.scale(dpr, dpr);
            }
            
            canvas.style.display = 'block';
        }

        function countActiveParticles() {
            let count = 0;
            for (let p of particles) {
                if (p.active) count++;
            }
            return count;
        }

        function createRocket() {
            const activeCount = countActiveParticles();
            if (activeCount > FIREWORK_CONFIG.maxActiveParticles) return;

            const x = Math.random() * window.innerWidth;
            const yStart = window.innerHeight;
            const hue = Math.random() * 360;

            const p = getParticle();
            if (p) {
                p.x = x;
                p.y = yStart;
                p.vx = (Math.random() - 0.5) * 0.8; // Gi·∫£m ngang
                p.vy = - (8 + Math.random() * 4) * FIREWORK_CONFIG.rocketSpeedMultiplier;
                p.life = 0;
                p.maxLife = 40 + Math.random() * 15; // Ng·∫Øn h∆°n
                p.color = `hsl(${hue}, 100%, 70%)`;
                p.size = (1.5 + Math.random() * 0.8) * FIREWORK_CONFIG.particleSizeMultiplier;
                p.active = true;
                p.isRocket = true;
            }

            setTimeout(() => {
                if (!isRunning) return;
                const yExplode = window.innerHeight * (0.2 + Math.random() * 0.4);
                createExplosion(x, yExplode, hue);
            }, 800 + Math.random() * 400); // Bay nhanh h∆°n
        }

        function createExplosion(x, y, baseHue) {
            const activeCount = countActiveParticles();
            if (activeCount > FIREWORK_CONFIG.maxActiveParticles * 0.7) return;

            const numParticles = Math.floor(50 + Math.random() * 40); // √çt h∆°n
            
            // Ch·ªâ m·ªôt lo·∫°i explosion ƒë∆°n gi·∫£n
            for (let i = 0; i < numParticles; i++) {
                const p = getParticle();
                if (!p) continue;
                
                p.x = x;
                p.y = y;
                const angle = Math.random() * Math.PI * 2;
                const speed = (3 + Math.random() * 6) * FIREWORK_CONFIG.explosionSpeedMultiplier;
                p.vx = Math.cos(angle) * speed;
                p.vy = Math.sin(angle) * speed * 0.8 - 1.5;
                
                p.life = 0;
                p.maxLife = 40 + Math.random() * 40;
                
                const hueVariation = Math.random() * 60 - 30;
                p.color = `hsl(${baseHue + hueVariation}, ${85 + Math.random()*15}%, ${55 + Math.random()*30}%)`;
                
                p.size = (0.6 + Math.random() * 1.5) * FIREWORK_CONFIG.particleSizeMultiplier;
                p.active = true;
                p.trail = Math.random() > 0.5;
                p.trailLength = 1 + Math.random() * 2;
            }
        }

        function animate(time) {
            if (!isRunning) return;
            
            // S·ª≠ d·ª•ng setTimeout thay v√¨ requestAnimationFrame cho in-app browsers
            setTimeout(() => {
                requestAnimationFrame(animate);
            }, 1000 / FIREWORK_CONFIG.targetFPS);
            
            const delta = lastTime === 0 ? 1 : Math.min((time - lastTime) / 16, 2); // Fixed delta
            lastTime = time;

            // Clear v·ªõi opacity cao h∆°n ƒë·ªÉ √≠t particle t·ªìn ƒë·ªçng
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

            // V·∫Ω particles (gi·ªØ ƒë∆°n gi·∫£n)
            for (let p of particles) {
                if (!p.active) continue;

                p.x += p.vx * delta;
                p.y += p.vy * delta;
                p.vy += 0.08 * delta; // Gravity nh·∫π h∆°n
                p.life += delta;
                
                if (p.life >= p.maxLife) {
                    p.active = false;
                    continue;
                }

                const progress = p.life / p.maxLife;
                const alpha = 1 - progress;
                
                ctx.fillStyle = p.color.replace(')', `, ${alpha})`).replace('hsl', 'hsla');
                ctx.beginPath();
                
                const currentSize = p.size * (1 - progress * 0.4);
                ctx.arc(p.x, p.y, currentSize, 0, Math.PI * 2);
                ctx.fill();
            }

            // T·∫°o ph√°o m·ªõi
            if (time > nextExplosionTime) {
                const minInt = FIREWORK_CONFIG.explosionIntervalMin;
                const maxInt = FIREWORK_CONFIG.explosionIntervalMax;
                
                createRocket();
                nextExplosionTime = time + Math.random() * (maxInt - minInt) + minInt;
            }
        }

        // ====================== KH·ªûI ƒê·ªòNG ======================
        const btn = document.getElementById('startBtn');
        
        async function start() {
            btn.disabled = true;
            btn.textContent = "ƒêANG T·∫¢I...";
            
            try {
                // Kh·ªüi t·∫°o nh·∫°c (kh√¥ng b·∫Øt l·ªói)
                await initBackgroundMusic();
                
                btn.textContent = "B·∫ÆT ƒê·∫¶U";
                btn.disabled = false;
                
                // ·∫®n n√∫t v√† c·∫£nh b√°o
                btn.style.opacity = '0';
                btn.style.pointerEvents = 'none';
                setTimeout(() => {
                    btn.style.display = 'none';
                    document.getElementById('orientationWarning').style.display = 'none';
                }, 600);

                // Kh·ªüi t·∫°o canvas
                initCanvas();
                createParticlePool();

                // Th·ª≠ ph√°t nh·∫°c (kh√¥ng quan tr·ªçng n·∫øu kh√¥ng ƒë∆∞·ª£c)
                playBackgroundMusic();

                // B·∫Øt ƒë·∫ßu animation
                isRunning = true;
                startTime = performance.now();
                lastTime = startTime;
                nextExplosionTime = startTime + 300;

                requestAnimationFrame(animate);
                
            } catch (error) {
                console.error("L·ªói:", error);
                // V·∫´n ti·∫øp t·ª•c d√π c√≥ l·ªói
                btn.disabled = false;
                btn.textContent = "B·∫ÆT ƒê·∫¶U";
                
                // V·∫´n kh·ªüi ƒë·ªông ph√°o hoa
                if (!isRunning) {
                    initCanvas();
                    createParticlePool();
                    isRunning = true;
                    startTime = performance.now();
                    requestAnimationFrame(animate);
                }
            }
        }

        // ====================== EVENT LISTENERS ======================
        document.addEventListener('DOMContentLoaded', function() {
            // Ph√°t hi·ªán in-app browser
            const isInApp = detectInAppBrowser();
            
            // Thi·∫øt l·∫≠p n√∫t m·ªü trong tr√¨nh duy·ªát
            setupOpenInBrowser();
            
            // N·∫øu kh√¥ng ph·∫£i in-app browser, hi·ªÉn th·ªã n√∫t b·∫Øt ƒë·∫ßu ngay
            if (!isInApp) {
                document.getElementById('orientationWarning').style.display = 'none';
            }
            
            // X·ª≠ l√Ω n√∫t b·∫Øt ƒë·∫ßu
            const btn = document.getElementById('startBtn');
            btn.addEventListener('click', start);
            btn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                start();
            }, { passive: false });
        });
        
        // X·ª≠ l√Ω resize
        window.addEventListener('resize', function() {
            if (isRunning) {
                initCanvas();
            }
        });
        
        // X·ª≠ l√Ω khi tho√°t tab
        window.addEventListener('beforeunload', function() {
            if (backgroundMusic && isMusicPlaying) {
                backgroundMusic.pause();
            }
        });
    </script>
</body>
</html>
