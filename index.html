<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pháo Hoa Cao Trào Lặp Lại</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            font-family: system-ui, sans-serif;
            color: #fff;
        }
        #canvas {
            position: absolute;
            inset: 0;
            z-index: 1;
            display: none;
        }
        #startBtn {
            position: relative;
            z-index: 10;
            padding: 20px 54px;
            font-size: 30px;
            font-weight: 700;
            color: #111;
            background: linear-gradient(135deg, #ffffff, #f3f3f3);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 28px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: transform 0.35s cubic-bezier(.22,1,.36,1), box-shadow 0.35s ease, background 0.35s ease;
            letter-spacing: 0.5px;
            animation: floatSoft 4s ease-in-out infinite;
            overflow: hidden;
        }

        #startBtn::after {
            content: "";
            position: absolute;
            top: 0;
            left: -120%;
            width: 120%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255,255,255,0.7), transparent);
            transition: left 0.6s ease;
        }

        #startBtn:hover::after {
            left: 120%;
        }

        #startBtn:hover {
            transform: translateY(-6px);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 1);
        }

        #startBtn:active {
            transform: scale(0.92);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            transition: transform 0.15s ease;
        }

        #startBtn.clicked {
            animation: fadeOutSmooth 0.9s cubic-bezier(.4,0,.2,1) forwards;
        }

        .btn-text {
            position: relative;
            z-index: 1;
            color: #111;
        }

        @keyframes floatSoft {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        @keyframes fadeOutSmooth {
            0% { opacity: 1; transform: scale(1) translateY(0); }
            40% { opacity: 0.8; transform: scale(1.05) translateY(-16px); }
            100% { opacity: 0; transform: scale(0.7) translateY(60px); visibility: hidden; }
        }
    </style>
</head>
<body>
    <button id="startBtn">
        <span class="btn-text">BẮT ĐẦU</span>
    </button>
    <canvas id="canvas"></canvas>

    <script>
        // ====================== CẤU HÌNH ÂM THANH ======================
        const SOUND_CONFIG = {
            masterVolume: 1.2, // GIẢM để giảm lag âm thanh
            baseInterval: 1600,
            intervalVariation: 1000,
            fadeInTime: 0.2,
            fadeOutTime: 1.2,
            frequencyBlend: {
                min: 30,
                max: 80,
                glideTime: 0.6
            },
            layers: {
                sub: { weight: 0.9, freqRange: [30, 70] }, // GIẢM
                deep: { weight: 0.6, freqRange: [20, 45] }, // GIẢM
                rumble: { weight: 0.3, freqRange: [100, 300] } // GIẢM
            }
        };

        // ====================== CẤU HÌNH PHÁO HOA TỐI ƯU LAG ======================
        const FIREWORK_CONFIG = {
            maxParticlesPerExplosion: 100, // GIẢM đáng kể
            maxIntensity: 2.5, // GIẢM
            
            // Hệ thống điều chỉnh tốc độ với LOOP LẠI sau 15 giây
            adaptiveExplosionRate: {
                // Tốc độ bình thường
                normalRate: {
                    minInterval: 2000, // TĂNG để giảm lag
                    maxInterval: 3000   // TĂNG
                },
                
                // Tốc độ cao trào - ĐÃ TỐI ƯU GIẢM LAG
                climaxRate: {
                    minInterval: 200,     // TĂNG để giảm lag
                    maxInterval: 400,     // TĂNG
                    duration: 8000,       // GIẢM: từ 10s xuống 8s
                    burstCount: 2,        // GIẢM: từ 3 xuống 2 rocket
                    burstDelay: 100       // TĂNG để giảm lag
                },
                
                // Các giai đoạn với LOOP LẠI sau 15 giây
                phases: {
                    buildup: 7000,        // 7 giây đầu - xây dựng
                    climax: 8000,         // 8 giây tiếp - cao trào
                    cooldown: 7000        // 7 giây cuối - hạ nhiệt
                },
                loopDelay: 15000          // 15 giây chờ trước khi lặp lại
            },
            
            targetFPS: 60,
            maxActiveParticles: 1500,     // GIẢM MẠNH: từ 2200 xuống 1500
            particleSizeMultiplier: 0.4,  // GIẢM: từ 0.5 xuống 0.4
            rocketSpeedMultiplier: 0.8,   // GIẢM
            explosionSpeedMultiplier: 0.7, // GIẢM
            
            // CẤU HÌNH KHOẢNG CÁCH: TỐI ƯU LAG
            distanceDistribution: {
                near: 0.2,     // GIẢM MẠNH: từ 0.25 xuống 0.2
                far: 0.8       // TĂNG
            },
            
            distanceSettings: {
                near: {
                    minHeight: 0.25,       // TĂNG thêm để giảm lag
                    maxHeight: 0.45,
                    sizeMultiplier: 1.0,   // GIẢM: từ 1.1 xuống 1.0
                    speedMultiplier: 1.0,  // GIẢM
                    brightnessBoost: 1.0,  // GIẢM
                    glowIntensity: 1.0     // GIẢM
                },
                far: {
                    minHeight: 0.6,
                    maxHeight: 0.9,
                    sizeMultiplier: 0.6,   // GIẢM
                    speedMultiplier: 0.8,  // GIẢM
                    brightnessBoost: 0.8,  // GIẢM
                    glowIntensity: 0.7     // GIẢM
                }
            },
            
            // SAO BĂNG CONFIG
            shootingStars: {
                count: 3,           // Số sao băng khi bắt đầu
                speed: 15,          // Tốc độ
                length: 100,        // Độ dài đuôi
                colors: ['#ffffff', '#4fc3f7', '#e57373', '#fff176'],
                size: 2.5,          // Kích thước
                fadeDuration: 1000  // Thời gian fade
            },
            
            // CÁC LOẠI PHÁO HOA - GIẢM ĐỘ PHỨC TẠP
            explosionTypes: {
                normal: {
                    chrysanthemum: 0.3,
                    peony: 0.3,
                    palm: 0.1,
                    willow: 0.1,
                    ring: 0.1,
                    crossette: 0.1
                },
                climax: {
                    chrysanthemum: 0.25,
                    peony: 0.3,
                    palm: 0.1,
                    willow: 0.1,
                    ring: 0.1,
                    crossette: 0.1,
                    special: 0.05  // GIẢM MẠNH loại đặc biệt
                }
            }
        };

        const MUSIC_FILE = 'phaobong.mp3';

        let canvas, ctx, audioCtx, masterGain, backgroundMusic;
        let particles = [];
        let shootingStars = [];
        let particlePoolSize = FIREWORK_CONFIG.maxParticlesPerExplosion * 25; // GIẢM
        let lastTime = 0, startTime = 0;
        let isRunning = false;
        let nextExplosionTime = 0;
        let nextSoundTime = 0;
        let soundSequence = 0;
        let activeSounds = new Set();
        let isMusicLoaded = false;
        let isMusicPlaying = false;
        
        // Hệ thống điều chỉnh cao trào với LOOP
        let climaxSystem = {
            phase: 'buildup',
            phaseStartTime: 0,
            climaxIntensity: 1.0,
            isClimaxActive: false,
            climaxMultiplier: 1.0,
            loopCounter: 0,
            maxLoops: 100, // Lặp nhiều lần
            lastLoopTime: 0,
            
            soundIntensity: 1.0,
            lastBassTime: 0,
            bassInterval: 800
        };

        // ====================== HỆ THỐNG SAO BĂNG ======================
        function createShootingStars(count = FIREWORK_CONFIG.shootingStars.count) {
            const starsConfig = FIREWORK_CONFIG.shootingStars;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    if (!isRunning) return;
                    
                    const star = {
                        x: -50 - Math.random() * 100, // Bắt đầu từ ngoài màn hình bên trái
                        y: Math.random() * window.innerHeight * 0.3, // 30% trên cùng
                        vx: starsConfig.speed + Math.random() * 5,
                        vy: starsConfig.speed * 0.7 + Math.random() * 3,
                        life: 0,
                        maxLife: 1500 + Math.random() * 500,
                        color: starsConfig.colors[Math.floor(Math.random() * starsConfig.colors.length)],
                        size: starsConfig.size + Math.random() * 1,
                        trail: [],
                        maxTrailLength: starsConfig.length,
                        active: true,
                        brightness: 1.0
                    };
                    
                    shootingStars.push(star);
                    
                    // Tạo hiệu ứng lấp lánh cho sao băng
                    const sparkleInterval = setInterval(() => {
                        if (!star.active || !isRunning) {
                            clearInterval(sparkleInterval);
                            return;
                        }
                        
                        // Thêm điểm sáng vào đuôi
                        if (star.trail.length > 0) {
                            const trailPoint = star.trail[star.trail.length - 1];
                            createSparks(trailPoint.x, trailPoint.y, star.color);
                        }
                    }, 80);
                    
                }, i * 300); // Stagger các sao băng
            }
        }

        function createSparks(x, y, color) {
            const sparkCount = Math.floor(2 + Math.random() * 3); // Ít sparks hơn
            
            for (let i = 0; i < sparkCount; i++) {
                const spark = getParticle();
                if (!spark) continue;
                
                spark.x = x + (Math.random() - 0.5) * 10;
                spark.y = y + (Math.random() - 0.5) * 10;
                spark.vx = (Math.random() - 0.5) * 3;
                spark.vy = (Math.random() - 0.5) * 3;
                spark.life = 0;
                spark.maxLife = 30 + Math.random() * 30;
                spark.color = color;
                spark.size = 0.8 + Math.random() * 0.7;
                spark.active = true;
                spark.fade = 0.8;
                spark.drag = 0.92;
            }
        }

        function updateShootingStars(delta) {
            for (let i = shootingStars.length - 1; i >= 0; i--) {
                const star = shootingStars[i];
                
                if (!star.active) {
                    shootingStars.splice(i, 1);
                    continue;
                }
                
                // Cập nhật vị trí
                star.x += star.vx * delta;
                star.y += star.vy * delta;
                star.life += delta * 16.67; // Convert delta to ms
                
                // Thêm điểm vào đuôi
                star.trail.push({ x: star.x, y: star.y });
                if (star.trail.length > star.maxTrailLength) {
                    star.trail.shift();
                }
                
                // Fade out khi gần hết đời
                if (star.life > star.maxLife * 0.7) {
                    star.brightness = 1 - (star.life - star.maxLife * 0.7) / (star.maxLife * 0.3);
                }
                
                // Deactivate khi hết đời
                if (star.life >= star.maxLife) {
                    star.active = false;
                }
                
                // Deactivate khi ra khỏi màn hình
                if (star.x > window.innerWidth + 100 || star.y > window.innerHeight + 100) {
                    star.active = false;
                }
            }
        }

        function renderShootingStars() {
            ctx.save();
            
            for (const star of shootingStars) {
                if (!star.active || star.trail.length < 2) continue;
                
                // Vẽ đuôi sao băng
                ctx.beginPath();
                ctx.moveTo(star.trail[0].x, star.trail[0].y);
                
                for (let i = 1; i < star.trail.length; i++) {
                    ctx.lineTo(star.trail[i].x, star.trail[i].y);
                }
                
                const gradient = ctx.createLinearGradient(
                    star.trail[0].x, star.trail[0].y,
                    star.trail[star.trail.length - 1].x, star.trail[star.trail.length - 1].y
                );
                
                gradient.addColorStop(0, star.color.replace(')', ', 0)'));
                gradient.addColorStop(0.3, star.color.replace(')', `, ${0.7 * star.brightness})`));
                gradient.addColorStop(1, star.color.replace(')', `, ${0.3 * star.brightness})`));
                
                ctx.strokeStyle = gradient;
                ctx.lineWidth = star.size;
                ctx.lineCap = 'round';
                ctx.stroke();
                
                // Vẽ đầu sao băng
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size * 1.5, 0, Math.PI * 2);
                ctx.fillStyle = star.color.replace(')', `, ${star.brightness})`);
                ctx.fill();
                
                // Glow effect
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size * 3, 0, Math.PI * 2);
                const glowGradient = ctx.createRadialGradient(
                    star.x, star.y, 0,
                    star.x, star.y, star.size * 3
                );
                glowGradient.addColorStop(0, star.color.replace(')', `, ${0.5 * star.brightness})`));
                glowGradient.addColorStop(1, star.color.replace(')', ', 0)'));
                ctx.fillStyle = glowGradient;
                ctx.fill();
            }
            
            ctx.restore();
        }

        // ====================== HÀM ĐẾM PHÁO GẦN ======================
        function countNearParticles() {
            let count = 0;
            for (let p of particles) {
                if (p.active && p.isNear) count++;
            }
            return count;
        }

        // ====================== HỆ THỐNG ĐIỀU CHỈNH CAO TRÀO VỚI LOOP ======================
        function updateClimaxSystem(currentTime) {
            if (!startTime) return 1.0;
            
            const elapsed = currentTime - startTime;
            const phases = FIREWORK_CONFIG.adaptiveExplosionRate.phases;
            const totalPhaseTime = phases.buildup + phases.climax + phases.cooldown;
            
            // Tính thời gian trong chu kỳ hiện tại (looping)
            const cycleTime = elapsed % (totalPhaseTime + FIREWORK_CONFIG.adaptiveExplosionRate.loopDelay);
            
            if (cycleTime < phases.buildup) {
                // Phase 1: Xây dựng
                climaxSystem.phase = 'buildup';
                const progress = cycleTime / phases.buildup;
                climaxSystem.climaxIntensity = 1.0 + progress * 0.4; // GIẢM
                climaxSystem.soundIntensity = 1.0;
                
                // Tăng dần số sao băng khi xây dựng
                if (Math.random() < 0.01 * progress) {
                    createShootingStars(1);
                }
                
            } else if (cycleTime < phases.buildup + phases.climax) {
                // Phase 2: Cao trào
                if (!climaxSystem.isClimaxActive) {
                    climaxSystem.isClimaxActive = true;
                    climaxSystem.phaseStartTime = currentTime;
                }
                climaxSystem.phase = 'climax';
                
                const climaxProgress = (cycleTime - phases.buildup) / phases.climax;
                
                // Intensity vừa phải để giảm lag
                if (climaxProgress < 0.3) {
                    climaxSystem.climaxIntensity = 1.4 + climaxProgress * 2.0;
                } else if (climaxProgress < 0.7) {
                    climaxSystem.climaxIntensity = 2.0 + (climaxProgress - 0.3) * 2.0;
                } else {
                    climaxSystem.climaxIntensity = 2.8 - (climaxProgress - 0.7) * 1.8;
                }
                
                climaxSystem.soundIntensity = Math.min(1.8, 1.0 + climaxSystem.climaxIntensity * 0.25);
                climaxSystem.bassInterval = Math.max(300, 800 - climaxSystem.climaxIntensity * 150);
                
                // Ít sao băng hơn ở cao trào
                if (Math.random() < 0.002) {
                    createShootingStars(1);
                }
                
            } else if (cycleTime < totalPhaseTime) {
                // Phase 3: Hạ nhiệt
                climaxSystem.phase = 'cooldown';
                climaxSystem.isClimaxActive = false;
                
                const cooldownProgress = (cycleTime - (phases.buildup + phases.climax)) / phases.cooldown;
                climaxSystem.climaxIntensity = Math.max(1.0, 1.4 - cooldownProgress * 0.4);
                climaxSystem.soundIntensity = Math.max(1.0, 1.2 - cooldownProgress * 0.2);
                
                // Tăng sao băng khi hạ nhiệt
                if (Math.random() < 0.015 * (1 - cooldownProgress)) {
                    createShootingStars(1);
                }
                
            } else {
                // Phase chờ đợi giữa các loop
                climaxSystem.phase = 'waiting';
                climaxSystem.climaxIntensity = 1.0;
                climaxSystem.soundIntensity = 1.0;
                
                // Sao băng ngẫu nhiên trong thời gian chờ
                if (Math.random() < 0.008) {
                    createShootingStars(1);
                }
            }
            
            climaxSystem.climaxMultiplier = 1.0 / climaxSystem.climaxIntensity;
            return climaxSystem.climaxIntensity;
        }

        function getCurrentExplosionInterval() {
            const config = FIREWORK_CONFIG.adaptiveExplosionRate;
            
            if (climaxSystem.phase === 'climax') {
                const min = config.climaxRate.minInterval * climaxSystem.climaxMultiplier;
                const max = config.climaxRate.maxInterval * climaxSystem.climaxMultiplier;
                return Math.random() * (max - min) + min;
            } else {
                const min = config.normalRate.minInterval * climaxSystem.climaxMultiplier;
                const max = config.normalRate.maxInterval * climaxSystem.climaxMultiplier;
                return Math.random() * (max - min) + min;
            }
        }

        function getExplosionTypeForPhase() {
            if (climaxSystem.phase === 'climax') {
                const rand = Math.random();
                let cumulative = 0;
                
                for (let [type, probability] of Object.entries(FIREWORK_CONFIG.explosionTypes.climax)) {
                    cumulative += probability;
                    if (rand <= cumulative) {
                        return type;
                    }
                }
            }
            
            const rand = Math.random();
            let cumulative = 0;
            
            for (let [type, probability] of Object.entries(FIREWORK_CONFIG.explosionTypes.normal)) {
                cumulative += probability;
                if (rand <= cumulative) {
                    return type;
                }
            }
            
            return 'peony';
        }

        // ====================== HỆ THỐNG NHẠC NỀN ======================
        function initBackgroundMusic() {
            return new Promise((resolve, reject) => {
                try {
                    backgroundMusic = new Audio();
                    backgroundMusic.src = MUSIC_FILE;
                    backgroundMusic.loop = true;
                    backgroundMusic.volume = 0.6; // GIẢM
                    backgroundMusic.preload = 'auto';
                    
                    backgroundMusic.addEventListener('loadeddata', () => {
                        isMusicLoaded = true;
                        resolve(true);
                    });
                    
                    backgroundMusic.addEventListener('error', (e) => {
                        console.error("Lỗi tải nhạc:", e);
                        // Vẫn tiếp tục dù không có nhạc
                        resolve(false);
                    });
                    
                    backgroundMusic.load();
                    
                } catch (e) {
                    console.error("Lỗi khởi tạo nhạc:", e);
                    resolve(false);
                }
            });
        }

        function playBackgroundMusic() {
            if (!backgroundMusic || !isMusicLoaded) {
                return false;
            }
            
            try {
                backgroundMusic.volume = 0;
                const playPromise = backgroundMusic.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        fadeMusicVolume(0, 0.6, 1.5);
                    }).catch(error => {
                        console.error("Lỗi phát nhạc:", error);
                    });
                }
                
                return true;
            } catch (e) {
                console.error("Lỗi khi phát nhạc:", e);
                return false;
            }
        }

        function fadeMusicVolume(from, to, duration) {
            if (!backgroundMusic) return;
            
            const startTime = Date.now();
            const endTime = startTime + duration * 1000;
            
            function updateVolume() {
                const now = Date.now();
                const progress = Math.min((now - startTime) / (duration * 1000), 1);
                const currentVolume = from + (to - from) * progress;
                
                backgroundMusic.volume = Math.max(0, Math.min(1, currentVolume));
                
                if (progress < 1) {
                    requestAnimationFrame(updateVolume);
                }
            }
            
            updateVolume();
        }

        // ====================== HỆ THỐNG ÂM THANH TỐI ƯU ======================
        function initAudioSystem() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                masterGain = audioCtx.createGain();
                masterGain.gain.value = SOUND_CONFIG.masterVolume;
                
                // Đơn giản hóa audio chain để giảm lag
                masterGain.connect(audioCtx.destination);
                
                return true;
            } catch (e) {
                console.log("Audio không được hỗ trợ, tiếp tục không âm thanh");
                return false;
            }
        }

        function createSimpleBassSound(frequency, duration = 1.0, volume = 1.0) {
            if (!audioCtx || activeSounds.size > 4) return null; // GIỚI HẠN số âm thanh
            
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sine';
            osc.frequency.value = frequency;
            
            gain.gain.setValueAtTime(0.001, now);
            gain.gain.exponentialRampToValueAtTime(volume, now + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
            
            osc.connect(gain).connect(masterGain);
            osc.start(now);
            osc.stop(now + duration);
            
            const soundId = Symbol();
            activeSounds.add(soundId);
            
            setTimeout(() => {
                activeSounds.delete(soundId);
            }, duration * 1000);
            
            return soundId;
        }

        function playBassSound() {
            if (!audioCtx || activeSounds.size > 3) return; // GIỚI HẠN
            
            const currentTime = performance.now();
            
            if (climaxSystem.phase === 'climax' && 
                currentTime - climaxSystem.lastBassTime > climaxSystem.bassInterval) {
                climaxSystem.lastBassTime = currentTime;
                
                if (Math.random() > 0.6) { // GIẢM tần suất
                    const baseFreq = 40 + Math.random() * 20 * climaxSystem.soundIntensity;
                    createSimpleBassSound(
                        baseFreq,
                        0.8 + Math.random() * 0.4,
                        SOUND_CONFIG.layers.sub.weight * climaxSystem.soundIntensity * 0.8
                    );
                }
            } else if (currentTime > nextSoundTime) {
                soundSequence = (soundSequence + 1) % 3; // GIẢM số loại âm thanh
                const baseFreq = 45 + Math.random() * 15;
                
                createSimpleBassSound(
                    baseFreq,
                    1.0 + Math.random() * 0.5,
                    SOUND_CONFIG.layers.sub.weight * 0.7
                );
                
                nextSoundTime = currentTime + SOUND_CONFIG.baseInterval + (Math.random() - 0.5) * SOUND_CONFIG.intervalVariation;
            }
        }

        // ====================== HỆ THỐNG PHÁO HOA TỐI ƯU LAG ======================
        function createParticlePool() {
            particles = [];
            
            for (let i = 0; i < particlePoolSize; i++) {
                particles.push({
                    x: 0, y: 0,
                    vx: 0, vy: 0,
                    life: 0, maxLife: 0,
                    color: '#fff',
                    size: 1.0,
                    active: false,
                    isNear: false,
                    isRocket: false,
                    isSpecial: false,
                    
                    trail: false,
                    sparkle: false,
                    glitter: false,
                    fade: 1.0,
                    gravity: 0.08, // GIẢM
                    drag: 0.97, // TĂNG
                    
                    glowSize: 0,
                    trailLength: 0
                });
            }
        }

        function getParticle() {
            // Tìm particle không active
            for (let p of particles) {
                if (!p.active) return p;
            }
            
            // Tìm particle cũ nhất
            let oldestParticle = null;
            let oldestLife = 0;
            for (let p of particles) {
                if (p.active) {
                    const lifeRatio = p.life / p.maxLife;
                    if (lifeRatio > oldestLife) {
                        oldestLife = lifeRatio;
                        oldestParticle = p;
                    }
                }
            }
            
            if (oldestParticle && oldestLife > 0.7) { // TĂNG ngưỡng tái sử dụng
                oldestParticle.active = false;
                return oldestParticle;
            }
            
            return null;
        }

        function initCanvas() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            canvas.style.display = 'block';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function countActiveParticles() {
            let count = 0;
            for (let p of particles) {
                if (p.active) count++;
            }
            return count;
        }

        function createRocket() {
            const activeCount = countActiveParticles();
            if (activeCount > FIREWORK_CONFIG.maxActiveParticles * 0.9) return; // TĂNG ngưỡng

            const maxNearParticles = FIREWORK_CONFIG.maxActiveParticles * 0.2;
            const currentNearCount = countNearParticles();
            
            let adjustedNearProb = FIREWORK_CONFIG.distanceDistribution.near;
            if (climaxSystem.phase === 'climax') {
                adjustedNearProb = currentNearCount > maxNearParticles ? 0.15 : 0.3;
            } else {
                adjustedNearProb = currentNearCount > maxNearParticles * 0.6 ? 0.1 : 0.2;
            }
            
            const isNear = Math.random() < adjustedNearProb;
            const settings = FIREWORK_CONFIG.distanceSettings[isNear ? 'near' : 'far'];
            
            const x = Math.random() * window.innerWidth;
            const yStart = window.innerHeight;
            const hue = Math.random() * 360;

            const p = getParticle();
            if (p) {
                p.x = x;
                p.y = yStart;
                p.vx = (Math.random() - 0.5) * 1.2 * climaxSystem.climaxIntensity;
                p.vy = -(10 + Math.random() * 5) * FIREWORK_CONFIG.rocketSpeedMultiplier * settings.speedMultiplier * climaxSystem.climaxIntensity;
                p.life = 0;
                p.maxLife = 40 + Math.random() * 15;
                p.color = `hsl(${hue}, 100%, ${isNear ? 80 : 70}%)`;
                p.size = (1.2 + Math.random() * 0.6) * FIREWORK_CONFIG.particleSizeMultiplier * settings.sizeMultiplier * climaxSystem.climaxIntensity;
                p.active = true;
                p.isRocket = true;
                p.isNear = isNear;
                p.glowSize = p.size * 2.0 * climaxSystem.climaxIntensity;
                p.isSpecial = climaxSystem.phase === 'climax' && Math.random() > 0.8; // GIẢM tỷ lệ đặc biệt
            }

            setTimeout(() => {
                if (!isRunning) return;
                
                const minHeight = settings.minHeight * window.innerHeight;
                const maxHeight = settings.maxHeight * window.innerHeight;
                const yExplode = minHeight + Math.random() * (maxHeight - minHeight);
                
                const explosionType = getExplosionTypeForPhase();
                createSimpleExplosion(x, yExplode, hue, isNear, explosionType);
                
                if (climaxSystem.phase === 'climax' && Math.random() > 0.7) {
                    playBassSound();
                }
            }, (isNear ? 500 : 700) + Math.random() * 400 / climaxSystem.climaxIntensity);
        }

        function createSimpleExplosion(x, y, baseHue, isNear, type = 'peony') {
            const activeCount = countActiveParticles();
            if (activeCount > FIREWORK_CONFIG.maxActiveParticles * 0.85) return;

            const settings = FIREWORK_CONFIG.distanceSettings[isNear ? 'near' : 'far'];
            const intensityMultiplier = climaxSystem.climaxIntensity;
            const particleMultiplier = 0.7 + intensityMultiplier * 0.3; // GIẢM
            
            // Đơn giản hóa: chỉ sử dụng 3 loại pháo chính
            if (type === 'special' && Math.random() > 0.9) { // RẤT HIẾM
                createSpecialExplosion(x, y, baseHue, isNear);
                return;
            }
            
            // Mặc định là peony (đơn giản nhất)
            const numParticles = Math.floor(((isNear ? 80 : 70) + Math.random() * 50) * particleMultiplier);
            
            for (let i = 0; i < numParticles; i++) {
                const p = getParticle();
                if (!p) continue;
                
                const angle = Math.random() * Math.PI * 2;
                const speed = (2 + Math.random() * 3) * FIREWORK_CONFIG.explosionSpeedMultiplier * settings.speedMultiplier * intensityMultiplier;
                
                p.x = x;
                p.y = y;
                p.vx = Math.cos(angle) * speed;
                p.vy = Math.sin(angle) * speed;
                p.life = 0;
                p.maxLife = (isNear ? 60 : 50) + Math.random() * 40;
                p.color = `hsl(${baseHue}, 100%, ${(isNear ? 70 : 60) + Math.random() * 15}%)`;
                p.size = (0.8 + Math.random() * 0.6) * FIREWORK_CONFIG.particleSizeMultiplier * settings.sizeMultiplier * intensityMultiplier;
                p.active = true;
                p.isNear = isNear;
                p.trail = Math.random() > 0.5;
                p.gravity = 0.1;
                p.drag = 0.97;
                p.glowSize = p.size * 1.5 * intensityMultiplier;
            }
        }

        function createSpecialExplosion(x, y, baseHue, isNear) {
            const activeCount = countActiveParticles();
            if (activeCount > FIREWORK_CONFIG.maxActiveParticles * 0.8) return;

            const settings = FIREWORK_CONFIG.distanceSettings[isNear ? 'near' : 'far'];
            const numParticles = Math.floor(120 * climaxSystem.climaxIntensity);
            
            const colors = [
                `hsl(${baseHue}, 100%, 70%)`,
                `hsl(${(baseHue + 120) % 360}, 100%, 70%)`,
                `hsl(${(baseHue + 240) % 360}, 100%, 70%)`
            ];
            
            for (let i = 0; i < numParticles; i++) {
                const p = getParticle();
                if (!p) continue;
                
                const angle = Math.random() * Math.PI * 2;
                const speed = (4 + Math.random() * 5) * FIREWORK_CONFIG.explosionSpeedMultiplier * settings.speedMultiplier * climaxSystem.climaxIntensity;
                
                p.x = x;
                p.y = y;
                p.vx = Math.cos(angle) * speed;
                p.vy = Math.sin(angle) * speed * 0.9;
                p.life = 0;
                p.maxLife = (isNear ? 70 : 60) + Math.random() * 40;
                p.color = colors[Math.floor(Math.random() * colors.length)];
                p.size = (0.9 + Math.random() * 0.7) * FIREWORK_CONFIG.particleSizeMultiplier * settings.sizeMultiplier * climaxSystem.climaxIntensity;
                p.active = true;
                p.isNear = isNear;
                p.trail = true;
                p.gravity = 0.12;
                p.drag = 0.96;
                p.glowSize = p.size * 2.0 * climaxSystem.climaxIntensity;
                p.isSpecial = true;
            }
        }

        // ====================== RENDER TỐI ƯU ======================
        function renderParticle(p, ctx, progress) {
            let alpha = p.isRocket ? (1 - progress ** 1.5) : (1 - progress ** 1.2); // GIẢM
            
            if (climaxSystem.phase === 'climax') {
                alpha *= 1.1;
            }
            
            if (p.isSpecial) {
                alpha *= 0.8 + 0.3 * Math.sin(progress * 25);
            }
            
            const fadeAlpha = p.fade !== undefined ? p.fade : 1.0;
            alpha *= fadeAlpha;
            
            // Đơn giản hóa glow
            if (p.glowSize && progress < 0.5 && alpha > 0.3) {
                ctx.shadowBlur = p.glowSize * (1 - progress);
                ctx.shadowColor = p.color;
            }
            
            ctx.fillStyle = p.color.replace(')', `, ${alpha})`).replace('hsl', 'hsla');
            ctx.beginPath();
            
            const currentSize = p.size * (p.isRocket ? 1.1 : (1 - progress * 0.3));
            ctx.arc(p.x, p.y, currentSize, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.shadowBlur = 0;
        }

        // ====================== ANIMATE CHÍNH TỐI ƯU ======================
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let fps = 60;

        function animate(time) {
            if (!isRunning) return;
            
            // Đơn giản hóa FPS calculation
            frameCount++;
            if (time - lastFpsUpdate > 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFpsUpdate = time;
                
                // Tự động điều chỉnh dựa trên FPS
                if (fps < 30) {
                    // Giảm intensity nếu FPS thấp
                    climaxSystem.climaxIntensity *= 0.9;
                }
            }
            
            const targetFrameTime = 1000 / FIREWORK_CONFIG.targetFPS;
            const delta = lastTime === 0 ? 1 : Math.min((time - lastTime) / targetFrameTime, 3.0);
            lastTime = time;

            // Cập nhật hệ thống cao trào với LOOP
            const climaxIntensity = updateClimaxSystem(time);
            
            // Clear canvas với độ trong suốt thay đổi theo FPS
            let clearAlpha = fps > 50 ? 0.1 : (fps > 30 ? 0.15 : 0.2);
            if (climaxIntensity > 2.0) {
                clearAlpha = Math.max(0.05, clearAlpha * 0.7);
            }
            
            ctx.fillStyle = `rgba(0,0,0,${clearAlpha})`;
            ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

            // Cập nhật và render sao băng
            updateShootingStars(delta);
            renderShootingStars();

            // Phát âm thanh (ít thường xuyên hơn)
            if (Math.random() < 0.7) { // GIẢM tần suất
                playBassSound();
            }

            // Render particles hiệu quả hơn
            ctx.save();
            
            let renderedCount = 0;
            const maxRenderPerFrame = 1200; // GIỚI HẠN nghiêm ngặt
            
            for (let p of particles) {
                if (!p.active) continue;
                
                if (renderedCount >= maxRenderPerFrame) {
                    // Bỏ qua nếu đã render đủ
                    p.active = false;
                    continue;
                }
                
                // Cập nhật vị trí
                p.x += p.vx * delta;
                p.y += p.vy * delta;

                if (!p.isRocket) {
                    p.vy += p.gravity * delta * climaxIntensity;
                    p.vx *= Math.pow(p.drag, delta);
                    p.vy *= Math.pow(p.drag, delta);
                }

                p.life += delta;
                if (p.life >= p.maxLife) {
                    p.active = false;
                    continue;
                }

                const progress = p.life / p.maxLife;
                renderParticle(p, ctx, progress);
                renderedCount++;
            }
            ctx.restore();

            // Tạo pháo mới với burst effect
            if (time > nextExplosionTime) {
                const interval = getCurrentExplosionInterval();
                const climaxConfig = FIREWORK_CONFIG.adaptiveExplosionRate.climaxRate;
                
                let rocketCount = 1;
                if (climaxSystem.phase === 'climax') {
                    rocketCount = climaxConfig.burstCount;
                    
                    // Đôi khi tạo thêm 1 rocket nữa để thêm ấn tượng
                    if (Math.random() < 0.3) {
                        rocketCount += 1;
                    }
                }
                
                for (let i = 0; i < rocketCount; i++) {
                    setTimeout(() => {
                        if (isRunning && countActiveParticles() < FIREWORK_CONFIG.maxActiveParticles * 0.8) {
                            createRocket();
                        }
                    }, i * climaxConfig.burstDelay);
                }
                
                nextExplosionTime = time + interval;
            }

            requestAnimationFrame(animate);
        }

        // ====================== KHỞI ĐỘNG VỚI SAO BĂNG ======================
        const btn = document.getElementById('startBtn');
        
        async function start() {
            btn.classList.add('clicked');
            
            // Tạo hiệu ứng sao băng mở màn
            setTimeout(() => {
                createShootingStars(5); // Nhiều sao băng hơn để mở màn
            }, 200);
            
            setTimeout(async () => {
                try {
                    await initBackgroundMusic();
                    
                    // Vẫn tiếp tục dù không có audio
                    initAudioSystem();
                    
                    playBackgroundMusic();
                    
                    initCanvas();
                    createParticlePool();

                    if (masterGain) {
                        masterGain.gain.setValueAtTime(0.001, audioCtx?.currentTime || 0);
                        if (audioCtx) {
                            masterGain.gain.exponentialRampToValueAtTime(SOUND_CONFIG.masterVolume, audioCtx.currentTime + 2);
                        }
                    }

                    isRunning = true;
                    startTime = performance.now();
                    lastTime = startTime;
                    
                    // Bắt đầu với tốc độ vừa phải
                    nextExplosionTime = startTime + 500;
                    nextSoundTime = startTime + 1000;

                    // Tạo thêm sao băng sau khi bắt đầu
                    setTimeout(() => {
                        createShootingStars(2);
                    }, 1500);
                    
                    setTimeout(() => {
                        createShootingStars(3);
                    }, 3000);

                    requestAnimationFrame(animate);
                    
                } catch (error) {
                    console.error("Lỗi khởi tạo:", error);
                    // Vẫn tiếp tục dù có lỗi
                    initCanvas();
                    createParticlePool();
                    isRunning = true;
                    startTime = performance.now();
                    lastTime = startTime;
                    nextExplosionTime = startTime + 500;
                    requestAnimationFrame(animate);
                }
            }, 800);
        }

        // ====================== EVENT LISTENERS ======================
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            start();
        }, { passive: false });
        
        btn.addEventListener('pointerdown', start);
        
        window.addEventListener('resize', () => {
            if (isRunning) {
                initCanvas();
                // Tạo sao băng khi resize
                createShootingStars(2);
            }
        });
        
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                isRunning = false;
                if (backgroundMusic) {
                    backgroundMusic.pause();
                }
            } else if (startTime > 0) {
                isRunning = true;
                if (backgroundMusic) {
                    playBackgroundMusic();
                }
                lastTime = performance.now();
                requestAnimationFrame(animate);
            }
        });
        
        // Thêm sao băng ngẫu nhiên khi click
        canvas.addEventListener('click', (e) => {
            if (isRunning) {
                createShootingStars(1);
                // Tạo hiệu ứng pháo hoa nhỏ tại click
                createSimpleExplosion(e.clientX, e.clientY, Math.random() * 360, true, 'peony');
            }
        });
    </script>
</body>
</html>
